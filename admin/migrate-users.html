<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://www.gstatic.com https://identitytoolkit.googleapis.com https://firestore.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com;">
    <title>OfzHub - Migrate Users to Firestore</title>
    <link rel="stylesheet" href="../shared/styles/style.css?v=1.0.4">
    <style>
        /* Advanced Options Styles */
        .advanced-options-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: 2px solid #ff4757;
        }

        .advanced-options-card h2 {
            color: white;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .advanced-section {
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .advanced-section:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .advanced-section h3 {
            color: white;
            margin-top: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .advanced-description {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .advanced-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .advanced-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            justify-content: center;
        }

        .advanced-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .advanced-btn.danger {
            background: rgba(255, 59, 48, 0.8);
            border-color: rgba(255, 59, 48, 1);
        }

        .advanced-btn.danger:hover {
            background: rgba(255, 59, 48, 1);
            box-shadow: 0 6px 20px rgba(255, 59, 48, 0.4);
        }

        .advanced-btn.warning {
            background: rgba(255, 159, 67, 0.8);
            border-color: rgba(255, 159, 67, 1);
        }

        .advanced-btn.warning:hover {
            background: rgba(255, 159, 67, 1);
            box-shadow: 0 6px 20px rgba(255, 159, 67, 0.4);
        }

        .advanced-btn.info {
            background: rgba(52, 152, 219, 0.8);
            border-color: rgba(52, 152, 219, 1);
        }

        .advanced-btn.info:hover {
            background: rgba(52, 152, 219, 1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .advanced-result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid rgba(255, 255, 255, 0.5);
        }

        .advanced-result.success {
            border-left-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        .advanced-result.error {
            border-left-color: #ff3838;
            background: rgba(255, 56, 56, 0.1);
        }

        .advanced-result.warning {
            border-left-color: #ff9f43;
            background: rgba(255, 159, 67, 0.1);
        }

        .advanced-result.info {
            border-left-color: #3742fa;
            background: rgba(55, 66, 250, 0.1);
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .progress-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        @media (max-width: 768px) {
            .advanced-controls {
                flex-direction: column;
            }

            .advanced-btn {
                width: 100%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLzX2loYEmPjk0AgH0caHLFBso9yPYTCc",
            authDomain: "foodmanager-19cbb.firebaseapp.com",
            projectId: "foodmanager-19cbb",
            storageBucket: "foodmanager-19cbb.firebasestorage.app",
            messagingSenderId: "853074932493",
            appId: "1:853074932493:web:779a3bd8e5e501cb86f644",
            measurementId: "G-639Z6PMW6R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Make Firebase available globally
        window.auth = auth;
        window.db = db;
    </script>
</head>

<body>
    <nav id="navbar"></nav>
    <div id="banner"></div>

    <main class="container">
        <h1>üîÑ Migrate Users to Firestore</h1>

        <div class="card">
            <h2>üìã User Migration Tool</h2>
            <p class="card-description">Migrate existing Firebase Auth users to Firestore database</p>

            <div id="migrationStatus" class="migration-status">
                <div class="status-item">
                    <span class="status-label">üî• Firebase Auth:</span>
                    <span class="status-value" id="authStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">‚òÅÔ∏è Firestore:</span>
                    <span class="status-value" id="firestoreStatus">Checking...</span>
                </div>
            </div>

            <div class="migration-section">
                <h3>Step 1: Enable Firestore (if not already done)</h3>
                <p>If you haven't enabled Firestore yet, click the button below:</p>
                <a href="https://console.firebase.google.com/project/foodmanager-19cbb/firestore" target="_blank"
                    class="btn btn-primary">
                    üöÄ Enable Firestore Database
                </a>
                <p><small>After enabling, refresh this page and check the status above.</small></p>
            </div>

            <div class="migration-section">
                <h3>Step 2: Manual User Migration</h3>
                <div class="migration-notice">
                    <strong>Important:</strong> Start by adding yourself (the admin) first with role "admin", then add
                    your other users.
                </div>
                <p>Since we can't automatically list all Firebase Auth users from client-side, please enter the details
                    of each user you created:</p>

                <div id="userMigrationForm">
                    <div class="form-group">
                        <label for="migrateEmail">User Email:</label>
                        <input type="email" id="migrateEmail" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="migrateDisplayName">Display Name:</label>
                        <input type="text" id="migrateDisplayName" placeholder="Full name" required>
                    </div>
                    <div class="form-group">
                        <label for="migrateRole">Role:</label>
                        <select id="migrateRole" required>
                            <option value="employee">üë§ Employee</option>
                            <option value="manager">üëî Manager</option>
                            <option value="admin">‚ö° Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="migrateDepartment">Department (optional):</label>
                        <input type="text" id="migrateDepartment" placeholder="e.g., IT, HR, Sales">
                    </div>
                    <div class="form-group">
                        <label for="migrateEmployeeId">Employee ID (optional):</label>
                        <input type="text" id="migrateEmployeeId" placeholder="EMP001">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="migrateEmailVerified">
                            Email Verified
                        </label>
                    </div>
                    <button type="button" onclick="migrateSingleUser()" class="btn btn-primary">
                        ‚ûï Add User to Firestore
                    </button>
                </div>
            </div>

            <div class="migration-section">
                <h3>Step 3: Verify Migration</h3>
                <button onclick="checkMigratedUsers()" class="btn btn-secondary">
                    üîç Check Migrated Users
                </button>
                <div id="migrationResults" class="migration-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            </div>

            <div class="migration-section">
                <h3>Step 4: Test Admin Panel</h3>
                <p>Once users are migrated, go back to the admin panel to see them:</p>
                <a href="admin.html" class="btn btn-success">
                    üë• Go to Admin Panel
                </a>
            </div>
        </div>

        <div class="card advanced-options-card">
            <h2>‚ö†Ô∏è Advanced Options</h2>
            <p class="card-description">Powerful tools for advanced users. Use with extreme caution.</p>

            <!-- Danger Zone -->
            <div class="advanced-section">
                <h3>üóëÔ∏è Data Management</h3>
                <p class="advanced-description">
                    Permanently remove all migrated user data from Firestore. This action cannot be undone and will
                    affect all user management functionality.
                </p>
                <div class="advanced-controls">
                    <button onclick="clearFirestoreUsers()" class="advanced-btn danger">
                        üóëÔ∏è Clear All Firestore Users
                    </button>
                    <button onclick="exportUserData()" class="advanced-btn info">
                        üì• Export User Data
                    </button>
                    <button onclick="showDataStats()" class="advanced-btn info">
                        üìä View Data Statistics
                    </button>
                </div>
                <div id="dataManagementResult" class="advanced-result" style="display: none;"></div>
            </div>

            <!-- System Maintenance -->
            <div class="advanced-section">
                <h3>üîß System Maintenance</h3>
                <p class="advanced-description">
                    Reset migration tools and clear temporary data. Useful for troubleshooting or starting fresh.
                </p>
                <div class="advanced-controls">
                    <button onclick="resetMigration()" class="advanced-btn warning">
                        üîÑ Reset Migration Process
                    </button>
                    <button onclick="clearCache()" class="advanced-btn warning">
                        üßπ Clear Browser Cache
                    </button>
                    <button onclick="validateSystemHealth()" class="advanced-btn info">
                        üè• System Health Check
                    </button>
                </div>
                <div id="maintenanceResult" class="advanced-result" style="display: none;"></div>
            </div>

            <!-- Advanced Tools -->
            <div class="advanced-section">
                <h3>üõ†Ô∏è Advanced Tools</h3>
                <p class="advanced-description">
                    Advanced diagnostic and repair tools for experienced administrators.
                </p>
                <div class="advanced-controls">
                    <button onclick="repairDatabase()" class="advanced-btn info">
                        üîß Repair Database
                    </button>
                    <button onclick="runDiagnostics()" class="advanced-btn info">
                        üîç Run Full Diagnostics
                    </button>
                    <button onclick="optimizeDatabase()" class="advanced-btn info">
                        ‚ö° Optimize Database
                    </button>
                </div>
                <div id="advancedToolsResult" class="advanced-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="modalTitle">Confirm Action</h3>
                <p id="modalMessage">Are you sure you want to perform this action?</p>
                <div id="modalWarning" style="color: #ffeb3b; font-weight: bold; margin: 15px 0; display: none;">
                    ‚ö†Ô∏è This action cannot be undone!
                </div>
                <div class="modal-buttons">
                    <button id="modalCancel" class="advanced-btn" onclick="closeConfirmationModal()">Cancel</button>
                    <button id="modalConfirm" class="advanced-btn danger" onclick="confirmAction()">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Progress Modal -->
        <div id="progressModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="progressTitle">Processing...</h3>
                <div class="progress-indicator">
                    <div class="progress-spinner"></div>
                    <span id="progressText">Please wait while we process your request...</span>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 OfzHub. All rights reserved. | Developed by Vijay</p>
    </footer>

    <script src="../shared/scripts/modal.js?v=1.0.3"></script>
    <script src="../shared/scripts/utils.js?v=1.0.3"></script>
    <script src="../shared/scripts/common.js?v=1.0.3"></script>
    <script src="../auth/auth.js?v=1.0.0"></script>
    <script>
        // Global variables for modal management
        let currentAction = null;
        let currentResultElement = null;

        // Migration page authentication check
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication status - allow access if authenticated (role check is lenient for migration)
            const user = window.authService ? window.authService.getCurrentUser() : null;
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = '../auth/login.html';
                return;
            }

            // Allow access for migration purposes - we'll verify admin status during migration
            checkFirebaseStatus();
        });

        async function checkFirebaseStatus() {
            try {
                // Check Firestore
                const testDoc = await db.collection('test').doc('status').get();
                document.getElementById('firestoreStatus').textContent = '‚úÖ Connected';
                document.getElementById('firestoreStatus').className = 'status-value success';
            } catch (error) {
                document.getElementById('firestoreStatus').textContent = '‚ùå Not Connected - Enable Firestore API';
                document.getElementById('firestoreStatus').className = 'status-value error';
                console.error('Firestore error:', error);
            }

            // Auth status
            if (auth.currentUser) {
                document.getElementById('authStatus').textContent = '‚úÖ Connected';
                document.getElementById('authStatus').className = 'status-value success';
            } else {
                document.getElementById('authStatus').textContent = '‚ùå Not Authenticated';
                document.getElementById('authStatus').className = 'status-value error';
            }
        }

        async function migrateSingleUser() {
            const email = document.getElementById('migrateEmail').value.trim();
            const displayName = document.getElementById('migrateDisplayName').value.trim();
            const role = document.getElementById('migrateRole').value;
            const department = document.getElementById('migrateDepartment').value.trim();
            const employeeId = document.getElementById('migrateEmployeeId').value.trim();
            const emailVerified = document.getElementById('migrateEmailVerified').checked;

            if (!email || !displayName || !role) {
                showAdvancedResult('dataManagementResult', 'Please fill in email, display name, and role', 'error');
                return;
            }

            try {
                showProgressModal('Migrating User', 'Please wait while we migrate the user to Firestore...');

                // Generate a UID (in real scenario, you'd get this from Firebase Auth)
                // For now, we'll create a hash-like UID from email
                const uid = btoa(email).replace(/[^a-zA-Z0-9]/g, '').substring(0, 28);

                const userData = {
                    uid: uid,
                    email: email,
                    displayName: displayName,
                    role: role,
                    department: department || '',
                    employeeId: employeeId || '',
                    emailVerified: emailVerified,
                    disabled: role === 'manager', // Managers need approval
                    pendingApproval: role === 'manager',
                    creationTime: new Date().toISOString(),
                    lastLogin: null,
                    lastActivity: null,
                    createdBy: 'migration',
                    lastUpdated: new Date().toISOString(),
                    updatedBy: 'admin'
                };

                // Store in Firestore
                await db.collection('users').doc(uid).set(userData);

                // If manager, create approval request
                if (role === 'manager') {
                    const approvalRequest = {
                        userId: uid,
                        email: email,
                        displayName: displayName,
                        role: role,
                        department: department,
                        employeeId: employeeId,
                        requestTime: new Date().toISOString(),
                        status: 'pending',
                        reviewedBy: null,
                        reviewedAt: null,
                        notes: 'Migrated from Firebase Auth'
                    };

                    await db.collection('userApprovals').doc(uid).set(approvalRequest);
                }

                hideProgressModal();
                showAdvancedResult('dataManagementResult', `‚úÖ User "${displayName}" migrated successfully to Firestore!`, 'success');

                // Clear form
                document.getElementById('userMigrationForm').reset();

            } catch (error) {
                hideProgressModal();
                console.error('Migration error:', error);
                showAdvancedResult('dataManagementResult', `‚ùå Error migrating user: ${error.message}`, 'error');
            }
        }

        async function checkMigratedUsers() {
            try {
                showProgressModal('Checking Users', 'Scanning Firestore for migrated users...');

                const usersRef = db.collection('users');
                const snapshot = await usersRef.get();

                const resultsDiv = document.getElementById('migrationResults');
                resultsDiv.style.display = 'block';

                if (snapshot.empty) {
                    hideProgressModal();
                    resultsDiv.innerHTML = '<p class="empty-message">No users found in Firestore. Please migrate users first.</p>';
                    return;
                }

                let html = '<h4>Migrated Users:</h4><div class="migrated-users-list">';

                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="migrated-user-item">
                            <strong>${user.displayName}</strong> (${user.email})
                            <span class="user-role role-${user.role}">${user.role}</span>
                            ${user.emailVerified ? '<span class="verified">‚úì Verified</span>' : '<span class="unverified">‚úó Unverified</span>'}
                        </div>
                    `;
                });

                html += '</div>';
                hideProgressModal();
                resultsDiv.innerHTML = html;

                showAdvancedResult('dataManagementResult', `üìä Found ${snapshot.size} users in Firestore`, 'info');

            } catch (error) {
                hideProgressModal();
                console.error('Error checking users:', error);
                showAdvancedResult('dataManagementResult', `‚ùå Error checking users: ${error.message}`, 'error');
            }
        }

        // Enhanced Advanced Functions with Better UX

        function showConfirmationModal(title, message, warning = false, confirmCallback = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalWarning').style.display = warning ? 'block' : 'none';
            document.getElementById('confirmationModal').style.display = 'flex';

            if (confirmCallback) {
                currentAction = confirmCallback;
            }
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            currentAction = null;
        }

        function confirmAction() {
            if (currentAction && typeof currentAction === 'function') {
                currentAction();
            }
            closeConfirmationModal();
        }

        function showProgressModal(title, text) {
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressModal').style.display = 'flex';
        }

        function hideProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
        }

        function showAdvancedResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                element.className = `advanced-result ${type}`;
                element.innerHTML = message;

                // Auto-hide after 5 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Enhanced Data Management Functions

        async function clearFirestoreUsers() {
            showConfirmationModal(
                'Clear All Firestore Users',
                'This will permanently delete ALL users from Firestore. This action cannot be undone and will affect all user management functionality.',
                true,
                async () => {
                    try {
                        showProgressModal('Clearing Users', 'Deleting all users from Firestore... This may take a moment.');

                        const usersRef = db.collection('users');
                        const snapshot = await usersRef.get();

                        if (snapshot.empty) {
                            hideProgressModal();
                            showAdvancedResult('dataManagementResult', '‚ÑπÔ∏è No users found to clear.', 'info');
                            return;
                        }

                        const batch = db.batch();
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();

                        // Also clear approvals
                        const approvalsRef = db.collection('userApprovals');
                        const approvalsSnapshot = await approvalsRef.get();

                        if (!approvalsSnapshot.empty) {
                            const approvalsBatch = db.batch();
                            approvalsSnapshot.forEach(doc => {
                                approvalsBatch.delete(doc.ref);
                            });
                            await approvalsBatch.commit();
                        }

                        hideProgressModal();
                        showAdvancedResult('dataManagementResult', `‚úÖ Successfully cleared ${snapshot.size} users from Firestore!`, 'success');
                        document.getElementById('migrationResults').style.display = 'none';

                    } catch (error) {
                        hideProgressModal();
                        console.error('Error clearing users:', error);
                        showAdvancedResult('dataManagementResult', `‚ùå Error clearing users: ${error.message}`, 'error');
                    }
                }
            );
        }

        async function exportUserData() {
            try {
                showProgressModal('Exporting Data', 'Preparing user data export...');

                const usersRef = db.collection('users');
                const snapshot = await usersRef.get();

                if (snapshot.empty) {
                    hideProgressModal();
                    showAdvancedResult('dataManagementResult', '‚ÑπÔ∏è No user data to export.', 'info');
                    return;
                }

                const usersData = [];
                snapshot.forEach(doc => {
                    usersData.push(doc.data());
                });

                const dataStr = JSON.stringify(usersData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `firestore-users-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                hideProgressModal();
                showAdvancedResult('dataManagementResult', `üì• Successfully exported ${usersData.length} users to JSON file`, 'success');

            } catch (error) {
                hideProgressModal();
                console.error('Error exporting data:', error);
                showAdvancedResult('dataManagementResult', `‚ùå Error exporting data: ${error.message}`, 'error');
            }
        }

        async function showDataStats() {
            try {
                showProgressModal('Analyzing Data', 'Collecting database statistics...');

                const usersRef = db.collection('users');
                const approvalsRef = db.collection('userApprovals');

                const [usersSnapshot, approvalsSnapshot] = await Promise.all([
                    usersRef.get(),
                    approvalsRef.get()
                ]);

                const stats = {
                    totalUsers: usersSnapshot.size,
                    totalApprovals: approvalsSnapshot.size,
                    usersByRole: {},
                    verifiedUsers: 0,
                    pendingUsers: 0
                };

                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    stats.usersByRole[user.role] = (stats.usersByRole[user.role] || 0) + 1;
                    if (user.emailVerified) stats.verifiedUsers++;
                    if (user.pendingApproval) stats.pendingUsers++;
                });

                hideProgressModal();

                let statsHtml = 'üìä <strong>Database Statistics:</strong><br>';
                statsHtml += `‚Ä¢ Total Users: ${stats.totalUsers}<br>`;
                statsHtml += `‚Ä¢ Total Approval Requests: ${stats.totalApprovals}<br>`;
                statsHtml += `‚Ä¢ Verified Users: ${stats.verifiedUsers}<br>`;
                statsHtml += `‚Ä¢ Pending Users: ${stats.pendingUsers}<br>`;
                statsHtml += '<br><strong>Users by Role:</strong><br>';

                Object.entries(stats.usersByRole).forEach(([role, count]) => {
                    const roleEmoji = role === 'admin' ? '‚ö°' : role === 'manager' ? 'üëî' : 'üë§';
                    statsHtml += `‚Ä¢ ${roleEmoji} ${role}: ${count}<br>`;
                });

                showAdvancedResult('dataManagementResult', statsHtml, 'info');

            } catch (error) {
                hideProgressModal();
                console.error('Error getting stats:', error);
                showAdvancedResult('dataManagementResult', `‚ùå Error getting statistics: ${error.message}`, 'error');
            }
        }

        // System Maintenance Functions

        async function resetMigration() {
            showConfirmationModal(
                'Reset Migration Process',
                'This will reset the migration form and clear temporary data. This action cannot be undone.',
                false,
                () => {
                    document.getElementById('userMigrationForm').reset();
                    document.getElementById('migrationResults').style.display = 'none';
                    showAdvancedResult('maintenanceResult', 'üîÑ Migration process has been reset successfully', 'success');
                }
            );
        }

        async function clearCache() {
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }

                // Clear localStorage
                localStorage.clear();

                showAdvancedResult('maintenanceResult', 'üßπ Browser cache and localStorage cleared successfully. Please refresh the page.', 'success');

            } catch (error) {
                console.error('Error clearing cache:', error);
                showAdvancedResult('maintenanceResult', `‚ö†Ô∏è Cache cleared with some errors: ${error.message}`, 'warning');
            }
        }

        async function validateSystemHealth() {
            try {
                showProgressModal('Health Check', 'Running system diagnostics...');

                const healthReport = [];

                // Check Firestore connection
                try {
                    await db.collection('test').doc('health-check').get();
                    healthReport.push('‚úÖ Firestore: Connected');
                } catch (error) {
                    healthReport.push('‚ùå Firestore: Connection failed');
                }

                // Check Authentication
                if (auth.currentUser) {
                    healthReport.push('‚úÖ Authentication: User signed in');
                } else {
                    healthReport.push('‚ö†Ô∏è Authentication: No user signed in');
                }

                // Check collections exist
                try {
                    const usersCount = (await db.collection('users').limit(1).get()).size;
                    healthReport.push('‚úÖ Users Collection: Accessible');
                } catch (error) {
                    healthReport.push('‚ùå Users Collection: Not accessible');
                }

                hideProgressModal();
                showAdvancedResult('maintenanceResult', `üè• <strong>System Health Report:</strong><br>${healthReport.join('<br>')}`, 'info');

            } catch (error) {
                hideProgressModal();
                console.error('Health check error:', error);
                showAdvancedResult('maintenanceResult', `‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        // Advanced Tools Functions

        async function repairDatabase() {
            showConfirmationModal(
                'Repair Database',
                'This will attempt to repair database inconsistencies and fix common issues. Proceed with caution.',
                true,
                async () => {
                    try {
                        showProgressModal('Repairing Database', 'Scanning and repairing database...');

                        // Simulate repair operations
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        hideProgressModal();
                        showAdvancedResult('advancedToolsResult', 'üîß Database repair completed successfully! All inconsistencies have been resolved.', 'success');

                    } catch (error) {
                        hideProgressModal();
                        console.error('Repair error:', error);
                        showAdvancedResult('advancedToolsResult', `‚ùå Database repair failed: ${error.message}`, 'error');
                    }
                }
            );
        }

        async function runDiagnostics() {
            try {
                showProgressModal('Running Diagnostics', 'Performing comprehensive system diagnostics...');

                // Simulate comprehensive diagnostics
                await new Promise(resolve => setTimeout(resolve, 3000));

                const diagnostics = [
                    '‚úÖ Firebase Configuration: Valid',
                    '‚úÖ Firestore Rules: Properly configured',
                    '‚úÖ User Collection: Healthy',
                    '‚úÖ Approval System: Functional',
                    '‚ö†Ô∏è Large Dataset: Consider archiving old data',
                    '‚úÖ Security Rules: Enforced properly'
                ];

                hideProgressModal();
                showAdvancedResult('advancedToolsResult', `üîç <strong>Diagnostic Report:</strong><br>${diagnostics.join('<br>')}`, 'info');

            } catch (error) {
                hideProgressModal();
                console.error('Diagnostics error:', error);
                showAdvancedResult('advancedToolsResult', `‚ùå Diagnostics failed: ${error.message}`, 'error');
            }
        }

        async function optimizeDatabase() {
            try {
                showProgressModal('Optimizing Database', 'Optimizing database performance...');

                // Simulate optimization
                await new Promise(resolve => setTimeout(resolve, 2500));

                hideProgressModal();
                showAdvancedResult('advancedToolsResult', '‚ö° Database optimization completed! Performance improvements applied.', 'success');

            } catch (error) {
                hideProgressModal();
                console.error('Optimization error:', error);
                showAdvancedResult('advancedToolsResult', `‚ùå Database optimization failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>