<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Email Verification Test Page</h1>
        <p>This page tests the email verification configuration and functionality.</p>

        <div class="test-section">
            <h3>1. Firebase Configuration Test</h3>
            <div id="firebaseTest"></div>
            <button onclick="testFirebaseConfig()">Test Firebase Config</button>
        </div>

        <div class="test-section">
            <h3>2. ActionCodeSettings Test</h3>
            <div id="actionCodeTest"></div>
            <button onclick="testActionCodeSettings()">Test ActionCodeSettings</button>
        </div>

        <div class="test-section">
            <h3>3. Email Verification Test</h3>
            <input type="email" id="testEmail" placeholder="Enter test email" style="padding: 10px; margin: 10px 0; width: 300px;">
            <div id="emailTest"></div>
            <button onclick="testEmailVerification()">Test Email Verification</button>
        </div>

        <div class="test-section">
            <h3>4. Quick Fix Instructions</h3>
            <div id="fixInstructions">
                <p><strong>If email verification is still not working:</strong></p>
                <ol>
                    <li>Go to <a href="https://console.firebase.google.com/project/foodmanager-19cbb/authentication/providers" target="_blank">Firebase Console ‚Üí Authentication ‚Üí Sign-in method</a></li>
                    <li>Ensure "Email/Password" is enabled</li>
                    <li>Check "Authorized domains" includes your domain</li>
                    <li>Verify email templates in Firebase Console ‚Üí Authentication ‚Üí Templates</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLzX2loYEmPjk0AgH0caHLFBso9yPYTCc",
            authDomain: "foodmanager-19cbb.firebaseapp.com",
            projectId: "foodmanager-19cbb",
            storageBucket: "foodmanager-19cbb.firebasestorage.app",
            messagingSenderId: "853074932493",
            appId: "1:853074932493:web:779a3bd8e5e501cb86f644",
            measurementId: "G-639Z6PMW6R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Action Code Settings for email verification and password reset
        const currentDomain = window.location.hostname;
        const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
        
        window.actionCodeSettings = {
            url: isLocalhost ? 
                `http://${currentDomain}/login.html` : 
                `https://${currentDomain}/login.html`,
            handleCodeInApp: false
        };

        // Make Firebase available globally
        window.auth = auth;
        window.db = db;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testFirebaseConfig() {
            try {
                // Test Firebase initialization
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    showResult('firebaseTest', '‚úÖ Firebase initialized successfully', 'success');
                } else {
                    showResult('firebaseTest', '‚ùå Firebase not initialized', 'error');
                    return;
                }

                // Test Auth service
                if (typeof auth !== 'undefined') {
                    showResult('firebaseTest', 
                        '‚úÖ Firebase Auth service available<br>‚úÖ Firebase initialized successfully', 'success');
                } else {
                    showResult('firebaseTest', '‚ùå Firebase Auth service not available', 'error');
                }
            } catch (error) {
                showResult('firebaseTest', `‚ùå Firebase config error: ${error.message}`, 'error');
            }
        }

        function testActionCodeSettings() {
            try {
                if (window.actionCodeSettings && window.actionCodeSettings.url) {
                    const url = window.actionCodeSettings.url;
                    showResult('actionCodeTest', 
                        `‚úÖ ActionCodeSettings configured correctly<br>
                         URL: ${url}<br>
                         Domain: ${window.location.hostname}<br>
                         Is Localhost: ${currentDomain === 'localhost' || currentDomain === '127.0.0.1'}`, 
                        'success');
                } else {
                    showResult('actionCodeTest', '‚ùå ActionCodeSettings not configured', 'error');
                }
            } catch (error) {
                showResult('actionCodeTest', `‚ùå ActionCodeSettings error: ${error.message}`, 'error');
            }
        }

        async function testEmailVerification() {
            const email = document.getElementById('testEmail').value;
            
            if (!email) {
                showResult('emailTest', '‚ùå Please enter an email address', 'error');
                return;
            }

            showResult('emailTest', '‚è≥ Testing email verification...', 'info');

            try {
                // Create a test user (this will be deleted immediately)
                const testPassword = 'TestPassword123!';
                
                // Create test user
                const userCredential = await auth.createUserWithEmailAndPassword(email, testPassword);
                const user = userCredential.user;

                showResult('emailTest', '‚úÖ Test user created successfully', 'success');

                // Test email verification
                try {
                    await user.sendEmailVerification(window.actionCodeSettings);
                    showResult('emailTest', 
                        '‚úÖ Email verification sent successfully!<br>Check your email (and spam folder).', 
                        'success');
                } catch (verificationError) {
                    showResult('emailTest', 
                        `‚ùå Email verification failed: ${verificationError.code}<br>
                         Error: ${verificationError.message}`, 
                        'error');
                }

                // Clean up - delete test user
                try {
                    await user.delete();
                    showResult('emailTest', 
                        '‚úÖ Email verification test completed<br>‚úÖ Test user cleaned up', 
                        'success');
                } catch (deleteError) {
                    showResult('emailTest', 
                        '‚ö†Ô∏è Email verification test completed but cleanup failed<br>Test user may still exist', 
                        'info');
                }

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showResult('emailTest', 
                        'Email already exists (that is good - means Firebase Auth is working)<br>' +
                        'Try with a different email or use the login page', 
                        'info');
                } else {
                    showResult('emailTest', 
                        'Test failed: ' + error.code + '<br>Error: ' + error.message, 
                        'error');
                }
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                testFirebaseConfig();
                testActionCodeSettings();
            }, 1000);
        });
    </script>
</body>
</html>