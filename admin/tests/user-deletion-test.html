<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Deletion Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß User Deletion Fix - Test Page</h1>
    
    <div class="test-section">
        <h2>üìã Test Instructions</h2>
        <p>This page helps verify that the user deletion fix is working correctly.</p>
        <ol>
            <li>Open the browser console to see detailed logs</li>
            <li>Click the test buttons below to verify functionality</li>
            <li>Check that users are properly removed from the admin panel</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üß™ Database Connection Tests</h2>
        <button class="btn-primary" onclick="testFirestoreConnection()">Test Firestore Connection</button>
        <button class="btn-primary" onclick="testRealtimeDBConnection()">Test Realtime Database Connection</button>
        <button class="btn-primary" onclick="testUserFetch()">Test User Fetch</button>
        <div id="dbTestResults"></div>
    </div>

    <div class="test-section">
        <h2>üë• User Management Tests</h2>
        <button class="btn-warning" onclick="testUserListRefresh()">Test User List Refresh</button>
        <button class="btn-warning" onclick="testBulkOperations()">Test Bulk Operations</button>
        <button class="btn-danger" onclick="simulateDeleteTest()">Simulate Delete Test</button>
        <div id="userTestResults"></div>
    </div>

    <div class="test-section">
        <h2>üìä Console Log Monitor</h2>
        <p>Open browser console (F12) to see detailed logs. This section shows recent test results:</p>
        <div id="consoleOutput"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration (same as admin.html)
        const firebaseConfig = {
            apiKey: "AIzaSyCLzX2loYEmPjk0AgH0caHLFBso9yPYTCc",
            authDomain: "foodmanager-19cbb.firebaseapp.com",
            projectId: "foodmanager-19cbb",
            storageBucket: "foodmanager-19cbb.firebasestorage.app",
            messagingSenderId: "853074932493",
            appId: "1:853074932493:web:779a3bd8e5e501cb86f644",
            measurementId: "G-639Z6PMW6R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Make Firebase available globally
        window.firebaseDB = database;
        window.auth = auth;
        window.db = db;
        window.firebaseRef = (path) => database.ref(path);
        window.firebaseGet = (ref) => ref.once('value');
        window.firebaseOnValue = (ref, callback) => ref.on('value', callback);
        window.firebasePush = (ref) => ref.push();
        window.firebaseUpdate = (ref, data) => ref.update(data);
        window.firebaseRemove = (ref) => ref.remove();

        // Utility functions
        function log(message, type = 'info') {
            console.log(`[TEST] ${message}`);
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="result ${type}"><strong>${timestamp}</strong>: ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `<div class="result ${type}"><strong>${timestamp}</strong>: ${message}</div>`;
        }

        // Test functions
        async function testFirestoreConnection() {
            log('Testing Firestore connection...');
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.limit(1).get();
                log('‚úÖ Firestore connection successful', 'success');
                showResult('dbTestResults', 'Firestore connection: ‚úÖ SUCCESS', 'success');
            } catch (error) {
                log(`‚ùå Firestore connection failed: ${error.message}`, 'error');
                showResult('dbTestResults', `Firestore connection: ‚ùå FAILED - ${error.message}`, 'error');
            }
        }

        async function testRealtimeDBConnection() {
            log('Testing Realtime Database connection...');
            try {
                const usersRef = firebaseRef('users');
                const snapshot = await firebaseGet(usersRef);
                log('‚úÖ Realtime Database connection successful', 'success');
                showResult('dbTestResults', 'Realtime Database connection: ‚úÖ SUCCESS', 'success');
            } catch (error) {
                log(`‚ùå Realtime Database connection failed: ${error.message}`, 'error');
                showResult('dbTestResults', `Realtime Database connection: ‚ùå FAILED - ${error.message}`, 'error');
            }
        }

        async function testUserFetch() {
            log('Testing user data fetch...');
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.get();
                const userCount = snapshot.size;
                log(`‚úÖ Successfully fetched ${userCount} users from Firestore`, 'success');
                showResult('dbTestResults', `User fetch: ‚úÖ SUCCESS - Found ${userCount} users`, 'success');
                
                // Also test Realtime Database
                try {
                    const realtimeUsersRef = firebaseRef('users');
                    const realtimeSnapshot = await firebaseGet(realtimeUsersRef);
                    const realtimeCount = realtimeSnapshot.exists() ? Object.keys(realtimeSnapshot.val()).length : 0;
                    log(`‚úÖ Realtime Database has ${realtimeCount} users`, 'success');
                    showResult('dbTestResults', `Realtime DB Users: ${realtimeCount} users`, 'info');
                } catch (realtimeError) {
                    log(`‚ö†Ô∏è Realtime Database user fetch failed: ${realtimeError.message}`, 'error');
                    showResult('dbTestResults', `Realtime DB Users: ‚ùå FAILED`, 'error');
                }
            } catch (error) {
                log(`‚ùå User fetch failed: ${error.message}`, 'error');
                showResult('dbTestResults', `User fetch: ‚ùå FAILED - ${error.message}`, 'error');
            }
        }

        async function testUserListRefresh() {
            log('Testing user list refresh mechanism...');
            showResult('userTestResults', 'This test should be performed in the actual admin panel. Navigate to Admin ‚Üí Users Tab ‚Üí Click Refresh.', 'info');
            log('‚ÑπÔ∏è Test user list refresh in admin panel manually', 'info');
        }

        async function testBulkOperations() {
            log('Testing bulk operations...');
            showResult('userTestResults', 'Bulk operations test requires multiple selected users. Test in admin panel with user checkboxes.', 'info');
            log('‚ÑπÔ∏è Test bulk operations in admin panel with selected users', 'info');
        }

        async function simulateDeleteTest() {
            log('üîç Simulating delete test scenario...');
            showResult('userTestResults', 'To test deletion: 1) Go to admin panel, 2) Select a user, 3) Click delete, 4) Check console logs and user removal', 'info');
            
            // Simulate the improved delete process
            try {
                const testUserId = 'test-user-' + Date.now();
                log(`üìù Simulated delete process for test user: ${testUserId}`, 'info');
                log('1. ‚úÖ Verify Firestore availability', 'success');
                log('2. ‚úÖ Check document existence', 'success');
                log('3. ‚úÖ Delete from Firestore', 'success');
                log('4. ‚úÖ Delete from Realtime Database', 'success');
                log('5. ‚úÖ Force refresh user list', 'success');
                log('6. ‚úÖ Show success message', 'success');
                showResult('userTestResults', '‚úÖ Simulated delete process completed successfully', 'success');
            } catch (error) {
                log(`‚ùå Simulated delete test failed: ${error.message}`, 'error');
                showResult('userTestResults', '‚ùå Simulated delete test failed', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ User Deletion Test Page Loaded', 'success');
            log('üìã Ready to run database and user management tests', 'info');
        });
    </script>
</body>
</html>