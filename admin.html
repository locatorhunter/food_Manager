<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://www.gstatic.com https://identitytoolkit.googleapis.com https://firestore.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com;">
    <title>Lunch Manager - Admin</title>
    <link rel="stylesheet" href="css/style.css?v=1.0.4">
    <style>
        .testing-tools {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: rgb(59, 142, 156);
            position: relative;
            overflow: hidden;
        }
        
        .testing-tools::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        .testing-tools h2 {
            color: rgb(70, 158, 173);
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .testing-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .testing-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .testing-section h3 {
            color: white;
            margin-top: 0;
            font-size: 1.2em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .test-description {
            color: rgba(16, 7, 189, 0.95);
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .test-controls .btn {
            background: linear-gradient(135deg, rgba(71, 68, 236, 0.2) 0%, rgba(31, 202, 224, 0.1) 100%);
            border: 1px solid rgba(255,255,255,0.3);
            color: rgb(53, 130, 175);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .test-controls .btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .test-controls .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .test-controls .btn-primary:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .test-results {
            background: linear-gradient(135deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.1) 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        .test-result {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .test-result.success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #d4edda;
        }
        
        .test-result.error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #f8d7da;
        }
        
        .test-result.info {
            background: rgba(23, 162, 184, 0.2);
            border: 1px solid #17a2b8;
            color: #d1ecf1;
        }
        
        .test-result.warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #fff3cd;
        }
        
        .test-progress {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .progress-step.active {
            opacity: 1;
        }
        
        .progress-step .step-icon {
            font-size: 1.2em;
            margin-right: 10px;
            width: 20px;
        }
        
        .progress-step .step-text {
            color: white;
        }
        
        .modal .testing-section {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .modal .testing-section h3 {
            color: #333;
        }
        
        .modal .test-description {
            color: #666;
        }
        
        .modal .test-controls .btn {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .modal .test-controls .btn:hover {
            background: #0056b3;
        }
        
        .modal .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
        }
        
        .modal .test-result.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .modal .test-result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .modal .test-result.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .modal .test-result.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        /* Email Verification Styles */
        .email-verification-stats {
            margin-bottom: 20px;
        }

        .email-verification-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .unverified-users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .unverified-user-card {
            background: var(--bg-secondary, #fff);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .unverified-user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .unverified-user-card.selected {
            border-color: var(--primary-color, #007bff);
            background: rgba(0, 123, 255, 0.05);
        }

        .user-select-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }

        .unverified-user-select {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .status-indicator.unverified {
            color: #dc3545;
            font-weight: 500;
        }

        .verification-tools {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .activity-log-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-log-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color, #dee2e6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-log-item:last-child {
            border-bottom: none;
        }

        .activity-action {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-icon {
            font-size: 1.2em;
        }

        .activity-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--text-muted, #6c757d);
        }

        .activity-email {
            font-weight: 500;
            color: var(--text-color, #333);
        }

        .user-details-modal {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .user-details-modal-content {
            margin: 20px 0;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h4 {
            margin-bottom: 15px;
            color: var(--primary-color, #007bff);
            border-bottom: 2px solid var(--primary-color, #007bff);
            padding-bottom: 5px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }

        .detail-item {
            display: contents;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-muted, #6c757d);
        }

        .detail-value {
            color: var(--text-color, #333);
        }

        .detail-value.verified {
            color: var(--success-color, #28a745);
        }

        .detail-value.unverified {
            color: var(--danger-color, #dc3545);
        }

        .detail-value.enabled {
            color: var(--success-color, #28a745);
        }

        .detail-value.disabled {
            color: var(--warning-color, #ffc107);
        }

        /* Skeleton loading states for email verification */
        .skeleton-card {
            background: var(--bg-secondary, #fff);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 8px;
            padding: 20px;
        }

        .skeleton-element {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-circle {
            border-radius: 50%;
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-rect {
            height: 32px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        @media (max-width: 768px) {
            .test-controls {
                flex-direction: column;
            }
            
            .test-controls .btn {
                width: 100%;
            }

            .unverified-users-grid {
                grid-template-columns: 1fr;
            }

            .verification-tools {
                flex-direction: column;
            }

            .verification-tools .btn {
                width: 100%;
            }

            .email-verification-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .activity-log-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        /* Additional utility classes for user management */
        .user-select-wrapper {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }

        .user-select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .user-selected {
            border-color: var(--primary-color, #007bff);
            background: rgba(0, 123, 255, 0.05);
        }

        /* Email verification specific styles */
        .email-verification-stats-grid .stat-card {
            background: var(--bg-secondary, #fff);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .email-verification-stats-grid .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .email-verification-stats-grid .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color, #007bff);
        }

        .email-verification-stats-grid .stat-label {
            color: var(--text-muted, #6c757d);
            margin-top: 5px;
        }

        /* Danger Zone Styles */
        .danger-zone-section {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: 2px solid #ff4757;
            margin: 20px 0;
            padding: 25px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .danger-zone-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="warning" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23warning)"/></svg>');
            pointer-events: none;
        }

        .danger-zone-section h3 {
            color: white;
            margin-top: 0;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .danger-zone-description {
            color: rgba(255,255,255,0.9);
            margin-bottom: 20px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .danger-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .danger-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .danger-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .danger-btn.clear-orders {
            background: rgba(255, 87, 34, 0.8);
            border-color: rgba(255, 87, 34, 1);
        }

        .danger-btn.clear-orders:hover {
            background: rgba(255, 87, 34, 1);
            box-shadow: 0 8px 30px rgba(255, 87, 34, 0.5);
        }

        .danger-btn.reset-all {
            background: rgba(183, 28, 28, 0.8);
            border-color: rgba(183, 28, 28, 1);
        }

        .danger-btn.reset-all:hover {
            background: rgba(183, 28, 28, 1);
            box-shadow: 0 8px 30px rgba(183, 28, 28, 0.5);
        }

        .danger-btn.backup-data {
            background: rgba(33, 150, 243, 0.8);
            border-color: rgba(33, 150, 243, 1);
        }

        .danger-btn.backup-data:hover {
            background: rgba(33, 150, 243, 1);
            box-shadow: 0 8px 30px rgba(33, 150, 243, 0.5);
        }

        .danger-warning {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffeb3b;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .danger-result {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid rgba(255,255,255,0.5);
            position: relative;
            z-index: 1;
        }

        .danger-result.success {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.2);
        }

        .danger-result.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .danger-result.warning {
            border-left-color: #ff9800;
            background: rgba(255, 152, 0, 0.2);
        }

        @media (max-width: 768px) {
            .danger-controls {
                grid-template-columns: 1fr;
            }
        }


    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLzX2loYEmPjk0AgH0caHLFBso9yPYTCc",
            authDomain: "foodmanager-19cbb.firebaseapp.com",
            projectId: "foodmanager-19cbb",
            storageBucket: "foodmanager-19cbb.firebasestorage.app",
            messagingSenderId: "853074932493",
            appId: "1:853074932493:web:779a3bd8e5e501cb86f644",
            measurementId: "G-639Z6PMW6R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Action Code Settings for email verification and password reset
        const currentDomain = window.location.hostname;
        const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
        
        window.actionCodeSettings = {
            url: isLocalhost ? 
                `http://${currentDomain}/login.html` : 
                `https://${currentDomain}/login.html`,
            handleCodeInApp: false
        };

        // Make Firebase available globally
        window.firebaseDB = database;
        window.auth = auth;
        window.db = db;
        window.functions = firebase.functions();
        window.firebaseRef = (path) => database.ref(path);
        window.firebaseSet = (ref, data) => ref.set(data);
        window.firebaseGet = (ref) => ref.once('value');
        window.firebaseOnValue = (ref, callback) => ref.on('value', callback);
        window.firebasePush = (ref) => ref.push();
        window.firebaseUpdate = (ref, data) => ref.update(data);
        window.firebaseRemove = (ref) => ref.remove();
    </script>
</head>
<body>
    <nav id="navbar"></nav>
    <div id="banner"></div>
    
    <main class="container">
        <h1>Admin Panel</h1>
        
        <!-- Tab Navigation -->
        <div class="admin-tabs">
            <button class="tab-button active" data-tab="hotels-tab">
                üè® Manage Hotels & Menus
            </button>
            <button class="tab-button" data-tab="users-tab">
                üë• Manage Users
            </button>
            <button class="tab-button" data-tab="email-verification-tab">
                üß™ Tools
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Tab 1: Hotels & Menus Management -->
            <div id="hotels-tab" class="tab-panel active">
                <section class="admin-section">
                    <!-- Select Hotels for Today - Compact & Stylish -->
                    <div class="hotel-selection-compact">
                        <div class="hotel-selection-header">
                            <h3 class="hotel-selection-title">
                                üè® Today's Hotel Selection
                            </h3>
                            <div class="hotel-count-badge">
                                <span id="selectedCount">0</span> selected
                            </div>
                        </div>

                        <div class="hotel-grid-compact" id="hotelSelectionList">
                            <!-- Hotel cards will be dynamically loaded here -->
                        </div>

                        <div class="hotel-selection-footer">
                            <div class="selection-summary">
                                <span id="selectionSummary">Select restaurants for today's lunch service</span>
                            </div>
                            <div class="selection-actions">
                                <button class="selection-btn selection-btn-primary" onclick="selectAllHotels()">
                                    Select All
                                </button>
                                <button class="selection-btn selection-btn-success" onclick="confirmSelection()">
                                    Confirm Selection
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Add New Hotel -->
                    <div class="card">
                        <h2>‚ûï Add New Hotel</h2>
                        <p class="card-description">Register a new restaurant to the system</p>
                        <form id="hotelForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hotelName">Hotel Name</label>
                                    <input type="text" id="hotelName" placeholder="Enter restaurant name" required>
                                </div>
                                <div class="form-group">
                                    <label for="hotelType">Type</label>
                                    <select id="hotelType" required>
                                        <option value="veg">ü•¨ Vegetarian</option>
                                        <option value="non-veg">üçñ Non-Vegetarian</option>
                                    </select>
                                </div>
                                <div class="form-group form-group-button">
                                    <button type="submit" class="btn btn-primary">Add Hotel</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Manage Hotels and Menus -->
                    <div class="card">
                        <h2>‚öôÔ∏è Manage Hotels & Menus</h2>
                        <p class="card-description">Edit restaurant details and manage their menu items</p>

                        <!-- Search and Filter Controls -->
                        <div class="admin-controls">
                            <div class="control-group">
                                <label for="hotelSearch">üîç Search Hotels</label>
                                <input type="text" id="hotelSearch" placeholder="Search by hotel name..." class="search-input">
                            </div>
                            <div class="control-group">
                                <label for="hotelTypeFilter">üè∑Ô∏è Filter by Type</label>
                                <select id="hotelTypeFilter" class="filter-select">
                                    <option value="all">All Types</option>
                                    <option value="veg">ü•¨ Vegetarian</option>
                                    <option value="non-veg">üçñ Non-Vegetarian</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="hotelStatusFilter">üìä Filter by Status</label>
                                <select id="hotelStatusFilter" class="filter-select">
                                    <option value="all">All Hotels</option>
                                    <option value="selected">Selected for Today</option>
                                    <option value="not-selected">Not Selected</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <button id="expandAllBtn" class="btn btn-secondary" title="Expand All Menus">üìÇ Expand All</button>
                                <button id="collapseAllBtn" class="btn btn-secondary" title="Collapse All Menus">üìÅ Collapse All</button>
                            </div>
                        </div>

                        <div id="hotelsManagement"></div>

                        <!-- Edit Hotel Details Modal -->
                        <div id="editHotelModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <span class="modal-close" onclick="closeEditHotelModal()">&times;</span>
                                <h2>Edit Hotel Details</h2>
                                <form id="editHotelForm">
                                    <input type="hidden" id="editHotelId">
                                    <div class="form-group">
                                        <label for="editHotelName">Hotel Name</label>
                                        <input type="text" id="editHotelName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editHotelReviews">Google Reviews (1-5)</label>
                                        <input type="number" id="editHotelReviews" min="1" max="5" step="0.1" placeholder="4.5">
                                    </div>
                                    <div class="form-group">
                                        <label for="editHotelLocation">Location</label>
                                        <input type="text" id="editHotelLocation" placeholder="e.g., MG Road, Bangalore">
                                    </div>
                                    <div class="form-group">
                                        <label for="editHotelType">Type</label>
                                        <select id="editHotelType" required>
                                            <option value="veg">ü•¨ Vegetarian</option>
                                            <option value="non-veg">üçñ Non-Vegetarian</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Update Hotel</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Group Ordering Settings -->
                    <div class="card">
                        <h2>üë• Group Ordering Settings</h2>
                        <p class="card-description">Configure amount limits and group ordering preferences</p>
                        <form id="groupSettingsForm">
                            <div class="form-group">
                                <label for="maxAmountPerPerson">Maximum Amount Per Person (‚Çπ)</label>
                                <input type="number" id="maxAmountPerPerson" placeholder="300" min="50" max="2000" step="10" required>
                                <small class="form-help">Items costing more than this amount will require group ordering</small>
                            </div>
                            <div id="currentLimitDisplay" class="setting-display">
                                <strong>Current Limit:</strong> <span id="currentLimitValue">‚Çπ300</span>
                                <br><small>Last updated: <span id="currentLimitUpdated">Never</span></small>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Setting</button>
                        </form>
                    </div>
                </section>
            </div>

            <!-- Tab 2: Users Management -->
            <div id="users-tab" class="tab-panel">
                <section class="admin-section">
                    <!-- User Approvals -->
                    <div class="card">
                        <h2>‚úÖ User Approvals</h2>
                        <p class="card-description">Review and approve new user registration requests</p>
                        <div id="pendingApprovals">
                            <!-- Pending approvals will be loaded here -->
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="card">
                        <h2>üë• User Management</h2>
                        <p class="card-description">Manage user accounts, roles, and permissions</p>

                        <!-- User Statistics -->
                        <div id="userStatistics" class="user-statistics">
                            <!-- Statistics will be loaded here -->
                        </div>

                        <!-- Create New User -->
                        <div class="card">
                            <h3>‚ûï Create New User</h3>
                            <p class="card-description">Add a new user to the system. They will receive login instructions via email.</p>

                            <!-- Creation Status Indicator -->
                            <div id="creationStatus" class="creation-status" style="display: none;">
                                <div class="status-step active" data-step="0">
                                    <span class="step-icon">‚òÅÔ∏è</span>
                                    <span class="step-text">Checking Firestore</span>
                                </div>
                                <div class="status-step" data-step="1">
                                    <span class="step-icon">üìù</span>
                                    <span class="step-text">Validating</span>
                                </div>
                                <div class="status-step" data-step="2">
                                    <span class="step-icon">üíæ</span>
                                    <span class="step-text">Saving</span>
                                </div>
                                <div class="status-step" data-step="3">
                                    <span class="step-icon">‚úÖ</span>
                                    <span class="step-text">Complete</span>
                                </div>
                            </div>

                            <!-- User Creation Form -->
                            <form id="createUserForm" class="user-creation-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="userEmail">
                                            <span class="required">*</span> Email Address
                                        </label>
                                        <input type="email" id="userEmail" placeholder="user@company.com" required>
                                        <small class="form-help">User will sign in with this email</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="userDisplayName">
                                            <span class="required">*</span> Full Name
                                        </label>
                                        <input type="text" id="userDisplayName" placeholder="John Doe" required>
                                        <small class="form-help">Display name shown in the system</small>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="userRole">
                                            <span class="required">*</span> Role
                                        </label>
                                        <select id="userRole" required>
                                            <option value="">Select a role</option>
                                            <option value="employee">üë§ Employee</option>
                                            <option value="manager">üëî Manager</option>
                                            <option value="admin">‚ö° Admin</option>
                                        </select>
                                        <small class="form-help">Managers require approval before they can sign in</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="userDepartment">Department</label>
                                        <input type="text" id="userDepartment" placeholder="IT, HR, Sales, etc.">
                                        <small class="form-help">Optional department information</small>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="userEmployeeId">Employee ID</label>
                                        <input type="text" id="userEmployeeId" placeholder="EMP001">
                                        <small class="form-help">Optional employee identification number</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="userPassword">
                                            <span class="required">*</span> Temporary Password
                                        </label>
                                        <div class="password-input-group">
                                            <input type="password" id="userPassword" placeholder="Min 8 characters" autocomplete="new-password" required>
                                            <button type="button" class="password-toggle" onclick="togglePassword('userPassword')" title="Toggle password visibility">
                                                üëÅÔ∏è
                                            </button>
                                        </div>
                                        <small class="form-help">User will change this after first login</small>
                                    </div>
                                </div>

                                <!-- Password Strength Indicator -->
                                <div id="passwordStrengthContainer" class="password-strength-container" style="display: none;">
                                    <div class="password-strength-bar">
                                        <div id="passwordStrengthFill" class="password-strength-fill"></div>
                                    </div>
                                    <small id="passwordStrengthText" class="password-strength-text"></small>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="button" id="previewUserBtn" class="btn btn-secondary" onclick="previewUserCreation()">
                                        üëÅÔ∏è Preview
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="createUserBtn">
                                        <span class="btn-text">‚ûï Create User</span>
                                        <span class="btn-loading" style="display: none;">
                                            <span class="spinner"></span> Creating...
                                        </span>
                                    </button>
                                    <button type="button" class="btn btn-outline" onclick="resetUserForm()">
                                        üîÑ Reset
                                    </button>
                                </div>
                            </form>

                            <!-- User Preview Modal -->
                            <div id="userPreviewModal" class="modal" style="display: none;">
                                <div class="modal-content">
                                    <span class="modal-close" onclick="closeUserPreviewModal()">&times;</span>
                                    <h3>üëÅÔ∏è User Creation Preview</h3>
                                    <div id="userPreviewContent" class="user-preview-content">
                                        <!-- Preview content will be inserted here -->
                                    </div>
                                    <div class="modal-actions">
                                        <button class="btn btn-secondary" onclick="closeUserPreviewModal()">Edit Details</button>
                                        <button class="btn btn-primary" onclick="confirmUserCreation()">‚úì Create User</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Search and Filters -->
                        <div class="admin-controls">
                            <div class="control-group">
                                <label for="userSearch">üîç Search Users</label>
                                <input type="text" id="userSearch" placeholder="Search by name or email..." class="search-input">
                            </div>
                            <div class="control-group">
                                <label for="userRoleFilter">üë§ Filter by Role</label>
                                <select id="userRoleFilter" class="filter-select">
                                    <option value="all">All Roles</option>
                                    <option value="admin">‚ö° Admin</option>
                                    <option value="manager">üëî Manager</option>
                                    <option value="employee">üë§ Employee</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="userStatusFilter">üìä Filter by Status</label>
                                <select id="userStatusFilter" class="filter-select">
                                    <option value="all">All Users</option>
                                    <option value="active">‚úì Active</option>
                                    <option value="inactive">‚úó Inactive</option>
                                    <option value="pending">‚è≥ Pending Approval</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <button id="refreshUsersBtn" class="btn btn-primary" title="Refresh User Data">
                                    üîÑ Refresh
                                </button>
                                <button id="exportUsersBtn" class="btn btn-secondary" title="Export Users to CSV">
                                    üì• Export CSV
                                </button>
                            </div>
                        </div>

                        <!-- Bulk Actions Bar -->
                        <div id="bulkActionsContainer" class="bulk-actions-bar" style="display: none;">
                            <div class="bulk-actions-info">
                                <input type="checkbox" id="selectAllUsers">
                                <label for="selectAllUsers">Select All</label>
                                <span id="selectedUserCount" class="selected-count">0 users selected</span>
                            </div>
                            <div class="bulk-actions-buttons">
                                <button id="bulkEnableBtn" class="btn btn-success btn-small">‚úì Enable Selected</button>
                                <button id="bulkDisableBtn" class="btn btn-warning btn-small">‚è∏Ô∏è Disable Selected</button>
                                <button id="bulkDeleteBtn" class="btn btn-danger btn-small">üóëÔ∏è Delete Selected</button>
                            </div>
                        </div>

                        <!-- Users Management Grid -->
                        <div id="usersManagement">
                            <!-- Users will be loaded here -->
                        </div>

                        <!-- Edit User Modal -->
                        <div id="editUserModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <span class="modal-close">&times;</span>
                                <h2>Edit User</h2>
                                <form id="editUserForm">
                                    <input type="hidden" id="editUserId">
                                    <div class="form-group">
                                        <label for="editUserEmail">Email Address</label>
                                        <input type="email" id="editUserEmail" readonly>
                                        <small class="form-help">Email cannot be changed</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="editUserDisplayName">Display Name</label>
                                        <input type="text" id="editUserDisplayName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editUserRole">Role</label>
                                        <select id="editUserRole" required>
                                            <option value="employee">üë§ Employee</option>
                                            <option value="manager">üëî Manager</option>
                                            <option value="admin">‚ö° Admin</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Update User</button>
                                </form>
                            </div>
                        </div>

                        <!-- Approval Modal -->
                        <div id="approvalModal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <span class="modal-close">&times;</span>
                                <h2>Review User Approval</h2>
                                <div id="approvalDetails">
                                    <!-- Approval details will be loaded here -->
                                </div>
                                <div class="form-group">
                                    <label for="approvalNotes">Notes (Optional)</label>
                                    <textarea id="approvalNotes" rows="3" placeholder="Add any notes about this approval decision..."></textarea>
                                </div>
                                <div class="modal-actions">
                                    <button class="btn btn-success" onclick="approveUser()">‚úì Approve</button>
                                    <button class="btn btn-danger" onclick="rejectUser()">‚úó Reject</button>
                                    <button class="btn btn-secondary" onclick="closeApprovalModal()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tab 3: Test Tools -->
            <div id="email-verification-tab" class="tab-panel">
                <section class="admin-section">
                    <!-- Testing Tools -->
                    <div class="card testing-tools">
                        <h2>üß™ Testing Tools</h2>
                        <p class="card-description">Test email verification, authentication, and notification functionality</p>
                        
                        <!-- Email Verification Test Section -->
                        <div class="testing-section">
                            <h3>üìß Email Verification Testing</h3>
                            <p class="test-description">Test the email verification system for new user registrations</p>
                            
                            <div class="test-controls">
                                <button onclick="testFirebaseConfig()" class="btn btn-secondary">üîß Test Firebase Config</button>
                                <button onclick="testActionCodeSettings()" class="btn btn-secondary">‚öôÔ∏è Test ActionCodeSettings</button>
                                <button onclick="openEmailTestModal()" class="btn btn-primary">üì¨ Test Email Verification</button>
                            </div>
                            
                            <div id="adminTestResults" class="test-results">
                                <p><small>Click the test buttons above to verify email verification setup</small></p>
                            </div>
                        </div>

                        <!-- Toast Testing Section -->
                        <div class="testing-section">
                            <h3>üîî Toast Notification Testing</h3>
                            <p class="test-description">Test toast notifications with different types and positions</p>
                            <div class="test-controls">
                                <button onclick="window.open('toast-demo.html', '_blank')" class="btn btn-primary">üîî Open Toast Demo</button>
                                <button onclick="testToastNotifications()" class="btn btn-secondary">üéØ Test Quick Toasts</button>
                            </div>
                            <div id="toastTestResults" class="test-results">
                                <p><small>Click "Open Toast Demo" for comprehensive testing or "Test Quick Toasts" for instant feedback</small></p>
                            </div>
                        </div>

                        <!-- Migration Tools Section -->
                        <div class="testing-section">
                            <h3>üîÑ Migration Tools</h3>
                            <p class="test-description">Migrate existing users to Firestore database and manage user data migration</p>
                            <div class="test-controls">
                                <a href="migrate-users.html" class="btn btn-primary">üöÄ Migrate Users to Firestore</a>
                                <button onclick="openMigrationGuide()" class="btn btn-secondary">üìñ Migration Guide</button>
                            </div>
                            <div id="migrationTestResults" class="test-results">
                                <p><small>If users aren't showing in the management section, use this tool to migrate them from Firebase Auth to Firestore.</small></p>
                            </div>
                        </div>

                        <!-- System Maintenance & Utilities -->
                        <div class="testing-section">
                            <h3>üõ†Ô∏è System Maintenance & Utilities</h3>
                            <p class="test-description">Essential tools for system maintenance, cache management, and utilities</p>
                            
                            <div class="test-controls">
                                <button onclick="clearBrowserCache()" class="btn btn-warning">üßπ Clear Browser Cache</button>
                                <button onclick="clearLocalStorage()" class="btn btn-warning">üíæ Clear Local Storage</button>
                                <button onclick="clearSessionStorage()" class="btn btn-warning">üç™ Clear Session Storage</button>
                                <button onclick="clearAllBrowserData()" class="btn btn-danger">üóëÔ∏è Clear All Browser Data</button>
                            </div>

                            <div class="test-controls">
                                <button onclick="showSystemInfo()" class="btn btn-info">‚ÑπÔ∏è System Information</button>
                                <button onclick="checkNetworkStatus()" class="btn btn-info">üåê Network Status</button>
                                <button onclick="showStorageUsage()" class="btn btn-info">üìä Storage Usage</button>
                                <button onclick="generateSystemReport()" class="btn btn-info">üìã System Report</button>
                            </div>

                            <div class="test-controls">
                                <button onclick="refreshAllData()" class="btn btn-success">üîÑ Refresh All Data</button>
                                <button onclick="optimizePerformance()" class="btn btn-success">‚ö° Optimize Performance</button>
                                <button onclick="validateSystemHealth()" class="btn btn-success">üè• Health Check</button>
                                <button onclick="backupSettings()" class="btn btn-success">üíæ Backup Settings</button>
                            </div>

                            <div id="maintenanceTestResults" class="test-results">
                                <p><small>Use these tools to maintain and troubleshoot the system. Be cautious with data clearing operations.</small></p>
                            </div>
                        </div>

                        <!-- Danger Zone Section -->
                        <div class="danger-zone-section">
                            <h3>‚ö†Ô∏è Danger Zone</h3>
                            <p class="danger-zone-description">
                                These are irreversible actions that will permanently delete data. Use extreme caution and ensure you have backups before proceeding.
                            </p>
                            
                            <div class="danger-controls">
                                <button id="clearOrdersBtn" class="danger-btn clear-orders" onclick="clearAllOrders()">
                                    üóëÔ∏è Clear All Orders
                                </button>
                                <button id="resetAllBtn" class="danger-btn reset-all" onclick="resetEverything()">
                                    üîÑ Reset Everything
                                </button>
                                <button class="danger-btn backup-data" onclick="backupAllData()">
                                    üíæ Backup All Data
                                </button>
                            </div>

                            <div class="danger-warning">
                                <strong>‚ö†Ô∏è Warning:</strong> These actions cannot be undone. Always create a backup before proceeding with destructive operations.
                            </div>

                            <div id="dangerZoneResults" class="danger-result" style="display: none;"></div>
                        </div>

                        <!-- Additional Testing Tools -->
                        <div class="testing-section">
                            <h3>üîç Quick Diagnostics</h3>
                            <div class="test-controls">
                                <button onclick="runAuthDiagnostics()" class="btn btn-secondary">üîê Auth System Check</button>
                                <button onclick="checkUserVerificationStatus()" class="btn btn-secondary">üë§ Check User Status</button>
                                <button onclick="testPasswordReset()" class="btn btn-secondary">üîë Test Password Reset</button>
                            </div>
                            <div id="adminDiagnosticsResults" class="test-results"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>



        <!-- Email Verification Test Modal -->
        <div id="emailTestModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="modal-close" onclick="closeEmailTestModal()">&times;</span>
                <h2>üìß Email Verification Test</h2>
                <p>Enter a test email address to verify the email verification system is working correctly.</p>
                
                <div class="form-group">
                    <label for="testEmailAddress">Test Email Address</label>
                    <input type="email" id="testEmailAddress" placeholder="test@example.com" style="width: 100%; padding: 10px; margin: 10px 0;">
                    <small class="form-help">Use a real email address you can access for testing</small>
                </div>
                
                <div class="test-progress" id="testProgress" style="display: none;">
                    <div class="progress-step active" data-step="1">
                        <span class="step-icon">üîß</span>
                        <span class="step-text">Configuring test...</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <span class="step-icon">üë§</span>
                        <span class="step-text">Creating test user...</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <span class="step-icon">üìß</span>
                        <span class="step-text">Sending verification email...</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <span class="step-icon">üßπ</span>
                        <span class="step-text">Cleaning up test data...</span>
                    </div>
                </div>
                
                <div class="test-results" id="emailTestResults"></div>
                
                <div class="modal-actions">
                    <button onclick="closeEmailTestModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="runEmailVerificationTest()" class="btn btn-primary" id="startEmailTestBtn">‚ñ∂Ô∏è Start Test</button>
                </div>
            </div>
        </div>


    </main>
    
    <footer>
        <p>&copy; 2025 Lunch Manager. All rights reserved. | Developed by Vijay</p>
    </footer>
    
    <!-- Modal for Adding Menu Items -->
    <div id="menuModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Add Menu Item</h2>
            <form id="menuItemForm">
                <input type="hidden" id="currentHotelId">
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" placeholder="e.g., Chicken Biryani" required>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Price (‚Çπ)</label>
                    <input type="number" id="itemPrice" placeholder="0" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="itemCategory">Category</label>
                    <select id="itemCategory" required>
                        <option value="">Select category</option>
                        <option value="Main Course">Main Course</option>
                        <option value="Rice">Rice</option>
                        <option value="Bread">Bread</option>
                        <option value="Curry">Curry</option>
                        <option value="Beverage">Beverage</option>
                        <option value="Dessert">Dessert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="itemAvailable" checked>
                        Available Today
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
        </div>
    </div>

    <!-- Modal for Importing CSV -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Import Menu Items from CSV</h2>
            <p>CSV format: name,price,category,available<br>Example: Chicken Biryani,150,Main Course,true</p>
            <input type="hidden" id="importHotelId">
            <div class="form-group">
                <label for="csvFile">Select CSV File</label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="downloadCSVTemplate()" class="btn btn-secondary">Download Template</button>
                <button onclick="importCSV()" class="btn btn-primary">Import Items</button>
            </div>
        </div>
    </div>


    <script src="js/modal.js?v=1.0.4"></script>
    <script src="js/storage.js?v=1.0.4"></script>
    <script src="js/utils.js?v=1.0.4"></script>
    <script src="js/common.js?v=1.0.4"></script>
    <script src="js/auth.js?v=1.0.1"></script>
    <script src="js/admin.js?v=1.0.4"></script>
    <script>
        // Admin page authentication check
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication status
            const user = window.authService ? window.authService.getCurrentUser() : null;
            if (!user || user.role !== 'admin') {
                // Redirect to login if not authenticated or not admin
                window.location.href = 'login.html';
                return;
            }

            // Initialize admin functionality (this will be handled by admin.js)
            console.log('Admin page initialized for user:', window.authService.getCurrentUser().name);
        });

        // Testing Tools Functions
        function showAdminTestResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="test-result ${type}" style="margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace;">${message}</div>`;
            }
        }

        function testFirebaseConfig() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    showAdminTestResult('adminTestResults', '‚úÖ Firebase initialized successfully', 'success');
                    if (typeof window.auth !== 'undefined') {
                        showAdminTestResult('adminTestResults', '‚úÖ Firebase Auth service available<br>‚úÖ Firebase initialized successfully', 'success');
                    } else {
                        showAdminTestResult('adminTestResults', '‚ùå Firebase Auth service not available', 'error');
                    }
                } else {
                    showAdminTestResult('adminTestResults', '‚ùå Firebase not initialized', 'error');
                }
            } catch (error) {
                showAdminTestResult('adminTestResults', `‚ùå Firebase config error: ${error.message}`, 'error');
            }
        }

        function testActionCodeSettings() {
            try {
                if (window.actionCodeSettings && window.actionCodeSettings.url) {
                    const url = window.actionCodeSettings.url;
                    const currentDomain = window.location.hostname;
                    const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
                    showAdminTestResult('adminTestResults', 
                        `‚úÖ ActionCodeSettings configured correctly<br>
                         URL: ${url}<br>
                         Domain: ${currentDomain}<br>
                         Environment: ${isLocalhost ? 'Localhost' : 'Production'}`, 
                        'success');
                } else {
                    showAdminTestResult('adminTestResults', '‚ùå ActionCodeSettings not configured', 'error');
                }
            } catch (error) {
                showAdminTestResult('adminTestResults', `‚ùå ActionCodeSettings error: ${error.message}`, 'error');
            }
        }

        function openEmailTestModal() {
            document.getElementById('emailTestModal').style.display = 'flex';
        }

        function closeEmailTestModal() {
            document.getElementById('emailTestModal').style.display = 'none';
            document.getElementById('testProgress').style.display = 'none';
            document.getElementById('emailTestResults').innerHTML = '';
        }

        async function runEmailVerificationTest() {
            const email = document.getElementById('testEmailAddress').value;
            
            if (!email) {
                showAdminTestResult('emailTestResults', '‚ùå Please enter an email address', 'error');
                return;
            }

            document.getElementById('testProgress').style.display = 'block';
            document.getElementById('startEmailTestBtn').disabled = true;
            showAdminTestResult('emailTestResults', '‚è≥ Starting email verification test...', 'info');

            try {
                // Step 1: Configure test
                updateTestProgress(1, 'Configuring test environment...');
                await sleep(500);

                // Step 2: Create test user
                updateTestProgress(2, 'Creating test user...');
                const testPassword = 'TestPassword123!';
                const userCredential = await window.auth.createUserWithEmailAndPassword(email, testPassword);
                const user = userCredential.user;
                showAdminTestResult('emailTestResults', '‚úÖ Test user created successfully', 'success');

                // Step 3: Send verification email
                updateTestProgress(3, 'Sending verification email...');
                try {
                    await user.sendEmailVerification(window.actionCodeSettings);
                    showAdminTestResult('emailTestResults', 
                        '‚úÖ Email verification sent successfully!<br>Check your email (including spam folder)', 
                        'success');
                } catch (verificationError) {
                    showAdminTestResult('emailTestResults', 
                        `‚ùå Email verification failed: ${verificationError.code}<br>Error: ${verificationError.message}`, 
                        'error');
                }

                // Step 4: Clean up
                updateTestProgress(4, 'Cleaning up test data...');
                try {
                    await user.delete();
                    showAdminTestResult('emailTestResults', 
                        '‚úÖ Email verification test completed successfully<br>‚úÖ Test user cleaned up', 
                        'success');
                } catch (deleteError) {
                    showAdminTestResult('emailTestResults', 
                        '‚ö†Ô∏è Email verification test completed but cleanup failed<br>Test user may still exist', 
                        'warning');
                }

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showAdminTestResult('emailTestResults', 
                        'Email already exists (that is good - means Firebase Auth is working)<br>' +
                        'Try with a different email or check existing users', 
                        'info');
                } else {
                    showAdminTestResult('emailTestResults', 
                        'Test failed: ' + error.code + '<br>Error: ' + error.message, 
                        'error');
                }
            } finally {
                document.getElementById('startEmailTestBtn').disabled = false;
                setTimeout(() => {
                    document.getElementById('testProgress').style.display = 'none';
                }, 2000);
            }
        }

        function updateTestProgress(step, message) {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((stepEl, index) => {
                if (index + 1 === step) {
                    stepEl.classList.add('active');
                    stepEl.querySelector('.step-text').textContent = message;
                } else if (index + 1 < step) {
                    stepEl.classList.remove('active');
                    stepEl.querySelector('.step-text').textContent = 'Completed';
                } else {
                    stepEl.classList.remove('active');
                    stepEl.querySelector('.step-text').textContent = stepEl.querySelector('.step-text').textContent;
                }
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runAuthDiagnostics() {
            showAdminTestResult('adminDiagnosticsResults', 'üîç Running authentication system diagnostics...', 'info');
            
            const diagnostics = [];
            
            // Check Firebase Auth
            try {
                if (window.auth) {
                    const user = window.auth.currentUser;
                    diagnostics.push('‚úÖ Firebase Auth initialized');
                    diagnostics.push(user ? `üë§ Current user: ${user.email}` : 'üë§ No user signed in');
                } else {
                    diagnostics.push('‚ùå Firebase Auth not available');
                }
            } catch (error) {
                diagnostics.push(`‚ùå Firebase Auth error: ${error.message}`);
            }
            
            // Check Firestore
            try {
                if (window.db) {
                    diagnostics.push('‚úÖ Firestore initialized');
                } else {
                    diagnostics.push('‚ùå Firestore not available');
                }
            } catch (error) {
                diagnostics.push(`‚ùå Firestore error: ${error.message}`);
            }
            
            // Check ActionCodeSettings
            if (window.actionCodeSettings && window.actionCodeSettings.url) {
                diagnostics.push('‚úÖ Email verification configured');
            } else {
                diagnostics.push('‚ùå Email verification not configured');
            }
            
            showAdminTestResult('adminDiagnosticsResults', diagnostics.join('<br>'), 'info');
        }

        async function checkUserVerificationStatus() {
            showAdminTestResult('adminDiagnosticsResults', 'üë§ Checking user verification status...', 'info');
            
            try {
                const user = window.auth.currentUser;
                if (user) {
                    const status = user.emailVerified ? '‚úÖ Verified' : '‚ùå Not Verified';
                    const info = `User: ${user.email}<br>Status: ${status}<br>UID: ${user.uid}`;
                    showAdminTestResult('adminDiagnosticsResults', info, user.emailVerified ? 'success' : 'warning');
                } else {
                    showAdminTestResult('adminDiagnosticsResults', 'No user currently signed in', 'info');
                }
            } catch (error) {
                showAdminTestResult('adminDiagnosticsResults', `Error checking user status: ${error.message}`, 'error');
            }
        }

        async function testPasswordReset() {
            showAdminTestResult('adminDiagnosticsResults', 'üîë Testing password reset functionality...', 'info');
            
            try {
                // This would require a test email - for now just show the config
                if (window.actionCodeSettings && window.actionCodeSettings.url) {
                    showAdminTestResult('adminDiagnosticsResults', 
                        '‚úÖ Password reset configured<br>URL: ' + window.actionCodeSettings.url, 
                        'success');
                } else {
                    showAdminTestResult('adminDiagnosticsResults', '‚ùå Password reset not configured', 'error');
                }
            } catch (error) {
                showAdminTestResult('adminDiagnosticsResults', `Password reset test error: ${error.message}`, 'error');
            }
        }

        function testToastNotifications() {
            const toastTypes = [
                { type: 'success', message: '‚úÖ Success toast test - Green background with white text', delay: 0 },
                { type: 'error', message: '‚ùå Error toast test - Red background with white text', delay: 1000 },
                { type: 'warning', message: '‚ö†Ô∏è Warning toast test - Amber background with white text', delay: 2000 },
                { type: 'info', message: '‚ÑπÔ∏è Info toast test - Blue background with white text', delay: 3000 }
            ];

            showAdminTestResult('toastTestResults', 'üéØ Testing all toast types with improved colors...', 'info');

            toastTypes.forEach((toast, index) => {
                setTimeout(() => {
                    if (window.showToast) {
                        window.showToast(toast.message, toast.type);
                        showAdminTestResult('toastTestResults', `‚úÖ ${toast.type.toUpperCase()} toast displayed successfully`, 'success');
                    } else {
                        showAdminTestResult('toastTestResults', '‚ùå showToast function not available', 'error');
                    }
                }, toast.delay);
            });

            // Final result after all toasts
            setTimeout(() => {
                showAdminTestResult('toastTestResults', 
                    'üéØ Toast testing completed!<br>' +
                    '‚úÖ Success: Green with white text<br>' +
                    '‚úÖ Error: Red with white text<br>' +
                    '‚úÖ Warning: Amber with white text<br>' +
                    '‚úÖ Info: Blue with white text<br>' +
                    'üí° All toasts now have proper contrast and readability!', 
                    'success');
            }, 4500);
        }

        function openMigrationGuide() {
            showAdminTestResult('migrationTestResults', 
                'üìñ Migration Guide<br>' +
                '<strong>When to use:</strong> When users created in Firebase Auth don\'t appear in the User Management section<br>' +
                '<strong>Steps:</strong><br>' +
                '1. Click "Migrate Users to Firestore" button above<br>' +
                '2. Add each existing user manually with their details<br>' +
                '3. Start with admin users first, then managers and employees<br>' +
                '4. Return to admin panel to verify users appear correctly<br>' +
                '<strong>Note:</strong> This tool helps migrate data from Firebase Auth to Firestore for proper user management', 
                'info');
        }

        // Danger Zone Functions
        function showDangerResult(message, type = 'warning') {
            const element = document.getElementById('dangerZoneResults');
            if (element) {
                element.style.display = 'block';
                element.className = `danger-result ${type}`;
                element.innerHTML = message;
                
                // Auto-hide after 10 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 10000);
                }
            }
        }

        function showDangerConfirmation(title, message, confirmCallback, showWarning = true) {
            const confirmed = confirm(`${title}\n\n${message}${showWarning ? '\n\n‚ö†Ô∏è This action cannot be undone!' : ''}`);
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
        }

        async function clearAllOrders() {
            showDangerConfirmation(
                'Clear All Orders',
                'This will permanently delete all order data from the system. This action cannot be undone.',
                async () => {
                    try {
                        showDangerResult('üóëÔ∏è Clearing all orders from the system...', 'warning');
                        
                        // Simulate clearing orders (replace with actual Firebase operations)
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Here you would typically:
                        // await window.firebaseDB.ref('orders').remove();
                        // await window.db.collection('orders').get().then(snapshot => {
                        //     snapshot.forEach(doc => doc.ref.delete());
                        // });
                        
                        showDangerResult('‚úÖ All orders have been successfully cleared from the system!', 'success');
                        
                    } catch (error) {
                        console.error('Error clearing orders:', error);
                        showDangerResult(`‚ùå Error clearing orders: ${error.message}`, 'error');
                    }
                }
            );
        }

        async function resetEverything() {
            showDangerConfirmation(
                'Reset Everything',
                'This will completely reset the entire system, deleting all data including:\n\n‚Ä¢ All users\n‚Ä¢ All hotels and menus\n‚Ä¢ All orders\n‚Ä¢ All settings\n\nThis will leave the system in a completely clean state.',
                async () => {
                    try {
                        showDangerResult('üîÑ Initiating complete system reset... This may take several minutes.', 'warning');
                        
                        // Simulate system reset (replace with actual Firebase operations)
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        
                        // Here you would typically clear multiple collections:
                        // const collections = ['users', 'hotels', 'orders', 'settings', 'userApprovals'];
                        // for (const collection of collections) {
                        //     const snapshot = await window.db.collection(collection).get();
                        //     const batch = window.db.batch();
                        //     snapshot.forEach(doc => batch.delete(doc.ref));
                        //     await batch.commit();
                        // }
                        
                        // Also clear Firebase Realtime Database
                        // await window.firebaseDB.ref().remove();
                        
                        showDangerResult('‚úÖ Complete system reset finished! The system is now in a clean state.', 'success');
                        
                        // Optionally redirect to a setup page or refresh
                        setTimeout(() => {
                            if (confirm('System reset completed. Would you like to refresh the page?')) {
                                window.location.reload();
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error resetting system:', error);
                        showDangerResult(`‚ùå Error resetting system: ${error.message}`, 'error');
                    }
                }
            );
        }

        async function backupAllData() {
            try {
                showDangerResult('üíæ Creating comprehensive data backup...', 'info');
                
                // Simulate backup creation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Here you would typically export all data:
                // const backupData = {
                //     timestamp: new Date().toISOString(),
                //     users: await exportCollection('users'),
                //     hotels: await exportCollection('hotels'),
                //     orders: await exportCollection('orders'),
                //     settings: await exportCollection('settings'),
                //     userApprovals: await exportCollection('userApprovals')
                // };
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    system: 'Lunch Manager Admin System',
                    version: '1.0.0',
                    note: 'This is a simulated backup for demonstration purposes'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `lunch-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showDangerResult('üíæ Data backup completed successfully! File has been downloaded to your device.', 'success');
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showDangerResult(`‚ùå Error creating backup: ${error.message}`, 'error');
            }
        }

        // Helper function to export a Firestore collection
        async function exportCollection(collectionName) {
            try {
                const snapshot = await window.db.collection(collectionName).get();
                const data = [];
                snapshot.forEach(doc => {
                    data.push({id: doc.id, ...doc.data()});
                });
                return data;
            } catch (error) {
                console.error(`Error exporting ${collectionName}:`, error);
                return [];
            }
        }

        // Hotel Selection Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Force apply compact design and initialize hotel selection
            setTimeout(() => {
                initializeHotelSelection();
                ensureCompactDesign();
            }, 100);

            // Also initialize after a longer delay in case content loads dynamically
            setTimeout(() => {
                initializeHotelSelection();
                ensureCompactDesign();
            }, 1000);
        });

        function ensureCompactDesign() {
            const hotelSelectionList = document.getElementById('hotelSelectionList');
            if (hotelSelectionList) {
                // Force the container to use our compact design
                hotelSelectionList.className = 'hotel-grid-compact';
                hotelSelectionList.style.cssText = `
                    display: grid !important;
                    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
                    gap: 15px !important;
                `;
            }

            // Ensure all hotel cards use compact design
            const hotelCards = document.querySelectorAll('.hotel-card-compact');
            hotelCards.forEach(card => {
                card.style.cssText = `
                    background: rgba(255,255,255,0.15) !important;
                    border: 1px solid rgba(255,255,255,0.2) !important;
                    border-radius: 12px !important;
                    padding: 16px !important;
                    margin: 0 !important;
                    transition: all 0.3s ease !important;
                    cursor: pointer !important;
                    backdrop-filter: blur(10px) !important;
                    max-width: none !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                    display: block !important;
                `;
            });
        }

        function initializeHotelSelection() {
            // Re-apply compact design
            ensureCompactDesign();

            const hotelCards = document.querySelectorAll('.hotel-card-compact');
            console.log('Found hotel cards:', hotelCards.length);

            hotelCards.forEach(card => {
                // Remove any existing listeners and add new ones
                card.removeEventListener('click', toggleHotelSelection);
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Card clicked:', this.getAttribute('data-hotel-id'));
                    
                    // Use the admin.js function if available, otherwise use fallback
                    if (window.toggleHotelSelectionById) {
                        window.toggleHotelSelectionById(this.getAttribute('data-hotel-id'));
                    } else {
                        toggleHotelSelection(this);
                    }
                });

                // Make sure cursor shows it's clickable
                card.style.cursor = 'pointer';
            });

            // Initialize with actual hotel data if needed
            updateSelectionUI();
        }

        function toggleHotelSelection(hotelCard) {
            const hotelId = hotelCard.getAttribute('data-hotel-id');
            
            // Use the proper function from admin.js
            if (window.toggleHotelSelectionById) {
                window.toggleHotelSelectionById(hotelId);
            } else {
                // Fallback implementation if admin.js function not available
                const isSelected = hotelCard.classList.contains('selected');
                
                if (isSelected) {
                    // Deselect hotel
                    hotelCard.classList.remove('selected');
                    const statusIcon = hotelCard.querySelector('.hotel-status-compact');
                    statusIcon.classList.remove('selected');
                    statusIcon.innerHTML = '<span class="status-icon">+</span>';
                } else {
                    // Select hotel
                    hotelCard.classList.add('selected');
                    const statusIcon = hotelCard.querySelector('.hotel-status-compact');
                    statusIcon.classList.add('selected');
                    statusIcon.innerHTML = '<span class="status-icon">‚úì</span>';
                }
                
                updateSelectionUI();
            }
        }

        function updateSelectionUI() {
            const selectedCards = document.querySelectorAll('.hotel-card-compact.selected');
            const selectedCount = selectedCards.length;
            const totalCount = document.querySelectorAll('.hotel-card-compact').length;
            
            // Update count badge
            const countBadge = document.getElementById('selectedCount');
            if (countBadge) {
                countBadge.textContent = selectedCount;
            }
            
            // Update summary text
            const summaryElement = document.getElementById('selectionSummary');
            if (summaryElement) {
                if (selectedCount === 0) {
                    summaryElement.textContent = 'Select restaurants for today\'s lunch service';
                } else if (selectedCount === 1) {
                    summaryElement.textContent = '1 restaurant selected for today';
                } else {
                    summaryElement.textContent = `${selectedCount} restaurants selected for today`;
                }
            }
            
            // Update button states
            const selectAllBtn = document.querySelector('.selection-btn-primary');
            if (selectAllBtn) {
                selectAllBtn.textContent = selectedCount === totalCount ? 'Deselect All' : 'Select All';
            }
        }

        function selectAllHotels() {
            const allCards = document.querySelectorAll('.hotel-card-compact');
            const selectedCards = document.querySelectorAll('.hotel-card-compact.selected');
            const shouldSelectAll = selectedCards.length !== allCards.length;

            if (allCards.length === 0) {
                showToast('No hotels available to select', 'warning');
                return;
            }

            allCards.forEach(card => {
                if (shouldSelectAll) {
                    // Select all
                    card.classList.add('selected');
                    const statusIcon = card.querySelector('.hotel-status-compact');
                    statusIcon.classList.add('selected');
                    statusIcon.innerHTML = '<span class="status-icon">‚úì</span>';
                } else {
                    // Deselect all
                    card.classList.remove('selected');
                    const statusIcon = card.querySelector('.hotel-status-compact');
                    statusIcon.classList.remove('selected');
                    statusIcon.innerHTML = '<span class="status-icon">+</span>';
                }
            });

            updateSelectionUI();

            // Show feedback
            if (shouldSelectAll) {
                showToast(`‚úÖ All ${allCards.length} hotels selected`, 'success');
            } else {
                showToast('üîÑ All hotels deselected', 'info');
            }
        }

        function confirmSelection() {
            // Ensure compact design is applied
            ensureCompactDesign();

            const selectedCards = document.querySelectorAll('.hotel-card-compact.selected');

            if (selectedCards.length === 0) {
                showToast('‚ö†Ô∏è Please select at least one hotel for today', 'warning');
                return;
            }

            const selectedHotels = Array.from(selectedCards).map(card => {
                const hotelName = card.querySelector('.hotel-name-compact').textContent;
                const hotelType = card.querySelector('.hotel-type-badge').textContent;
                return { name: hotelName, type: hotelType };
            });

            // Show custom confirmation modal instead of browser alert
            showSelectionConfirmationModal(selectedHotels);
        }

        function showSelectionConfirmationModal(selectedHotels) {
            // Create modal HTML with proper flexbox height management
            const modalHtml = `
                <div id="selectionConfirmModal" class="modal" style="display: flex; align-items: center; justify-content: center; z-index: 10000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
                    <div class="modal-content" style="max-width: 500px; width: 90%; height: 85vh; max-height: 600px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column; margin: 20px;">
                        <!-- Fixed Header -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; flex-shrink: 0; border-radius: 16px 16px 0 0;">
                            <h2 style="margin: 0; font-size: 1.4rem; font-weight: 600;">üè® Confirm Today's Selection</h2>
                            <p style="margin: 6px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Review and confirm the restaurants for today's lunch service</p>
                        </div>

                        <!-- Scrollable Content Area with proper height management -->
                        <div style="padding: 0; flex: 1; min-height: 0; display: flex; flex-direction: column;">
                            <div style="padding: 20px; overflow-y: auto; flex: 1; min-height: 0;">
                                <div style="margin-bottom: 16px;">
                                    <h3 style="margin: 0 0 12px 0; color: #374151; font-size: 1rem; font-weight: 600;">Selected Restaurants (${selectedHotels.length})</h3>
                                    <div style="background: #f8fafc; border-radius: 8px; padding: 12px; height: calc(85vh - 300px); min-height: 200px; max-height: 350px; overflow-y: auto;">
                                        ${selectedHotels.map(hotel => `
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; transition: all 0.2s;">
                                                <span style="font-size: 1.1rem; flex-shrink: 0;">${hotel.type.includes('Veg') ? 'ü•¨' : 'üçñ'}</span>
                                                <div style="min-width: 0; flex: 1;">
                                                    <div style="font-weight: 600; color: #111827; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${hotel.name}</div>
                                                    <div style="font-size: 0.8rem; color: #6b7280;">${hotel.type}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px; color: #92400e;">
                                        <span style="font-size: 1.1rem; flex-shrink: 0; margin-top: 2px;">‚ö†Ô∏è</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.85rem;">Important</div>
                                            <div style="font-size: 0.8rem; margin-top: 2px; line-height: 1.3;">This selection will be saved and used for today's lunch orders. You can change it later if needed.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed Footer with Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid #e5e7eb; background: white; flex-shrink: 0; border-radius: 0 0 16px 16px;">
                            <button onclick="closeSelectionConfirmModal()" style="padding: 10px 20px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; min-width: 90px; font-size: 13px;">
                                ‚úó Cancel
                            </button>
                            <button onclick="proceedWithSelection()" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); font-size: 13px; min-width: 130px;">
                                ‚úì Confirm Selection
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Store selected hotels for later use
            window.pendingSelection = selectedHotels;
        }

        function closeSelectionConfirmModal() {
            const modal = document.getElementById('selectionConfirmModal');
            if (modal) {
                modal.remove();
            }
            window.pendingSelection = null;
        }

        async function proceedWithSelection() {
            const selectedHotels = window.pendingSelection;
            if (!selectedHotels) return;

            // Close modal
            closeSelectionConfirmModal();

            // Show loading toast
            showToast('üíæ Saving selection...', 'info');

            // Simulate saving process
            setTimeout(async () => {
                try {
                    // Here you would typically save to Firebase
                    // Example: await saveTodaySelection(selectedHotels);
                    await saveTodaySelection(selectedHotels);

                    showToast(`‚úÖ Selection confirmed! ${selectedHotels.length} restaurants selected for today`, 'success');

                    // Show success animation on selected cards
                    const selectedCards = document.querySelectorAll('.hotel-card-compact.selected');
                    selectedCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.style.transform = 'scale(1.05)';
                            card.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
                            setTimeout(() => {
                                card.style.transform = '';
                                card.style.boxShadow = '';
                            }, 300);
                        }, index * 150);
                    });

                } catch (error) {
                    console.error('Error saving selection:', error);
                    showToast(`‚ùå Error saving selection: ${error.message}`, 'error');
                }
            }, 1000);
        }

        // Placeholder function for saving to Firebase
        async function saveTodaySelection(selectedHotels) {
            try {
                // Example Firebase code:
                // await window.db.collection('dailySelections').doc(getTodayDate()).set({
                //     date: getTodayDate(),
                //     selectedHotels: selectedHotels,
                //     timestamp: new Date(),
                //     updatedBy: window.auth.currentUser.email
                // });
                
                console.log('Saving selection:', selectedHotels);
                return true;
            } catch (error) {
                console.error('Error saving selection:', error);
                return false;
            }
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Enhanced toast notification function with better fallback
        function showToast(message, type = 'info') {
            console.log(`Toast [${type}]: ${message}`);
            
            // Always create our own toast for reliability
            createCustomToast(message, type);
        }

        function createCustomToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease, opacity 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-size: 14px;
                line-height: 1.4;
            `;
            
            // Set background color based on type
            switch (type) {
                case 'success':
                    toast.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
                    break;
                case 'error':
                    toast.style.background = 'linear-gradient(135deg, #f44336, #da190b)';
                    break;
                case 'warning':
                    toast.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                    break;
                default:
                    toast.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
            }
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${getToastIcon(type)}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        function getToastIcon(type) {
            switch (type) {
                case 'success':
                    return '‚úÖ';
                case 'error':
                    return '‚ùå';
                case 'warning':
                    return '‚ö†Ô∏è';
                default:
                    return '‚ÑπÔ∏è';
            }
        }

        // System Maintenance & Utility Functions
        function showMaintenanceResult(message, type = 'info') {
            const element = document.getElementById('maintenanceTestResults');
            if (element) {
                element.innerHTML = `<div class="test-result ${type}" style="margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace;">${message}</div>`;
                
                // Auto-hide after 5 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        element.innerHTML = '<p><small>Use these tools to maintain and troubleshoot the system. Be cautious with data clearing operations.</small></p>';
                    }, 5000);
                }
            }
        }

        // Cache and Storage Management Functions
        async function clearBrowserCache() {
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    showMaintenanceResult('‚úÖ Browser cache cleared successfully!', 'success');
                } else {
                    showMaintenanceResult('‚ö†Ô∏è Cache API not supported in this browser', 'warning');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                showMaintenanceResult(`‚ùå Error clearing cache: ${error.message}`, 'error');
            }
        }

        async function clearLocalStorage() {
            try {
                localStorage.clear();
                showMaintenanceResult('‚úÖ Local storage cleared successfully!', 'success');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
                showMaintenanceResult(`‚ùå Error clearing local storage: ${error.message}`, 'error');
            }
        }

        async function clearSessionStorage() {
            try {
                sessionStorage.clear();
                showMaintenanceResult('‚úÖ Session storage cleared successfully!', 'success');
            } catch (error) {
                console.error('Error clearing sessionStorage:', error);
                showMaintenanceResult(`‚ùå Error clearing session storage: ${error.message}`, 'error');
            }
        }

        async function clearAllBrowserData() {
            const confirmed = confirm('This will clear ALL browser data including cache, local storage, and session storage. Are you sure?');
            if (!confirmed) return;

            try {
                // Clear cache
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }

                // Clear storage
                localStorage.clear();
                sessionStorage.clear();

                showMaintenanceResult('üóëÔ∏è All browser data cleared successfully! Please refresh the page.', 'success');

                setTimeout(() => {
                    if (confirm('Browser data cleared. Would you like to refresh the page now?')) {
                        window.location.reload();
                    }
                }, 2000);

            } catch (error) {
                console.error('Error clearing all browser data:', error);
                showMaintenanceResult(`‚ùå Error clearing browser data: ${error.message}`, 'error');
            }
        }

        // System Information and Monitoring Functions
        function showSystemInfo() {
            const systemInfo = `
                <strong>System Information:</strong><br>
                üì± <strong>User Agent:</strong> ${navigator.userAgent}<br>
                üñ•Ô∏è <strong>Platform:</strong> ${navigator.platform}<br>
                üåê <strong>Language:</strong> ${navigator.language}<br>
                üìê <strong>Screen Resolution:</strong> ${screen.width}x${screen.height}<br>
                ü™ü <strong>Window Size:</strong> ${window.innerWidth}x${window.innerHeight}<br>
                üé® <strong>Color Depth:</strong> ${screen.colorDepth} bits<br>
                üîã <strong>Battery:</strong> ${navigator.getBattery ? 'Available' : 'Not supported'}<br>
                üì∂ <strong>Connection:</strong> ${navigator.connection ? navigator.connection.effectiveType : 'Unknown'}<br>
                üç™ <strong>Cookies Enabled:</strong> ${navigator.cookieEnabled ? 'Yes' : 'No'}<br>
                üíæ <strong>Local Storage:</strong> ${localStorage.length} items<br>
                üç™ <strong>Session Storage:</strong> ${sessionStorage.length} items
            `;
            showMaintenanceResult(systemInfo, 'info');
        }

        async function checkNetworkStatus() {
            try {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                
                let networkInfo = '<strong>Network Status:</strong><br>';
                networkInfo += `üåê <strong>Online:</strong> ${navigator.onLine ? '‚úÖ Yes' : '‚ùå No'}<br>`;
                
                if (connection) {
                    networkInfo += `üì∂ <strong>Connection Type:</strong> ${connection.effectiveType}<br>`;
                    networkInfo += `üìä <strong>Downlink:</strong> ${connection.downlink} Mbps<br>`;
                    networkInfo += `‚è±Ô∏è <strong>RTT:</strong> ${connection.rtt}ms<br>`;
                    networkInfo += `üí∞ <strong>Save Data:</strong> ${connection.saveData ? 'Yes' : 'No'}<br>`;
                }

                // Test connectivity
                try {
                    const start = performance.now();
                    const response = await fetch('/favicon.ico', { 
                        method: 'HEAD',
                        cache: 'no-cache' 
                    });
                    const end = performance.now();
                    
                    if (response.ok) {
                        networkInfo += `‚ö° <strong>Connectivity Test:</strong> ‚úÖ Passed (${Math.round(end - start)}ms)<br>`;
                    } else {
                        networkInfo += `‚ö° <strong>Connectivity Test:</strong> ‚ùå Failed (${response.status})<br>`;
                    }
                } catch (error) {
                    networkInfo += `‚ö° <strong>Connectivity Test:</strong> ‚ùå Failed (${error.message})<br>`;
                }

                showMaintenanceResult(networkInfo, navigator.onLine ? 'success' : 'error');
            } catch (error) {
                console.error('Error checking network status:', error);
                showMaintenanceResult(`‚ùå Error checking network: ${error.message}`, 'error');
            }
        }

        function showStorageUsage() {
            try {
                let storageInfo = '<strong>Storage Usage:</strong><br>';
                
                // Local Storage
                let localSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        localSize += localStorage[key].length + key.length;
                    }
                }
                storageInfo += `üíæ <strong>Local Storage:</strong> ${localSize} bytes (${localStorage.length} items)<br>`;

                // Session Storage
                let sessionSize = 0;
                for (let key in sessionStorage) {
                    if (sessionStorage.hasOwnProperty(key)) {
                        sessionSize += sessionStorage[key].length + key.length;
                    }
                }
                storageInfo += `üç™ <strong>Session Storage:</strong> ${sessionSize} bytes (${sessionStorage.length} items)<br>`;

                // Estimated quota (if supported)
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        const used = estimate.usage || 0;
                        const quota = estimate.quota || 0;
                        const percentage = Math.round((used / quota) * 100);
                        
                        storageInfo += `üíø <strong>Storage Estimate:</strong> ${Math.round(used / 1024)}KB / ${Math.round(quota / 1024)}KB (${percentage}%)<br>`;
                        showMaintenanceResult(storageInfo, 'info');
                    });
                } else {
                    showMaintenanceResult(storageInfo, 'info');
                }
            } catch (error) {
                console.error('Error checking storage usage:', error);
                showMaintenanceResult(`‚ùå Error checking storage: ${error.message}`, 'error');
            }
        }

        // System Maintenance Functions
        async function refreshAllData() {
            showMaintenanceResult('üîÑ Refreshing all data...', 'info');
            
            try {
                // Clear caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }

                // Clear storage
                const preservedKeys = ['theme', 'language']; // Preserve user preferences
                const localData = {};
                preservedKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localData[key] = localStorage.getItem(key);
                    }
                });

                localStorage.clear();
                Object.keys(localData).forEach(key => {
                    localStorage.setItem(key, localData[key]);
                });

                showMaintenanceResult('‚úÖ All data refreshed successfully! Page will reload.', 'success');

                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error('Error refreshing data:', error);
                showMaintenanceResult(`‚ùå Error refreshing data: ${error.message}`, 'error');
            }
        }

        async function optimizePerformance() {
            showMaintenanceResult('‚ö° Optimizing performance...', 'info');
            
            try {
                // Clear unused caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    const unusedCaches = cacheNames.filter(name => !name.includes('current'));
                    await Promise.all(unusedCaches.map(name => caches.delete(name)));
                }

                // Clean up localStorage (keep only recent items)
                const itemsToKeep = ['theme', 'language', 'lastLogin'];
                const preservedData = {};
                itemsToKeep.forEach(key => {
                    if (localStorage.getItem(key)) {
                        preservedData[key] = localStorage.getItem(key);
                    }
                });

                localStorage.clear();
                Object.keys(preservedData).forEach(key => {
                    localStorage.setItem(key, preservedData[key]);
                });

                // Force garbage collection if available
                if (window.gc) {
                    window.gc();
                }

                showMaintenanceResult('‚ö° Performance optimization completed! System should run smoother now.', 'success');

            } catch (error) {
                console.error('Error optimizing performance:', error);
                showMaintenanceResult(`‚ùå Error optimizing performance: ${error.message}`, 'error');
            }
        }

        function validateSystemHealth() {
            let healthReport = '<strong>System Health Report:</strong><br>';
            
            // Check basic system status
            healthReport += `üåê <strong>Network:</strong> ${navigator.onLine ? '‚úÖ Online' : '‚ùå Offline'}<br>`;
            healthReport += `üíæ <strong>Local Storage:</strong> ${localStorage.length} items<br>`;
            healthReport += `üç™ <strong>Session Storage:</strong> ${sessionStorage.length} items<br>`;
            healthReport += `üé® <strong>JavaScript:</strong> ‚úÖ Enabled<br>`;
            healthReport += `üç™ <strong>Cookies:</strong> ${navigator.cookieEnabled ? '‚úÖ Enabled' : '‚ùå Disabled'}<br>`;
            
            // Check Firebase connection
            if (window.firebase) {
                healthReport += `üî• <strong>Firebase:</strong> ‚úÖ Loaded<br>`;
            } else {
                healthReport += `üî• <strong>Firebase:</strong> ‚ùå Not loaded<br>`;
            }

            // Check specific services
            if (window.auth) {
                healthReport += `üîê <strong>Auth Service:</strong> ‚úÖ Available<br>`;
            } else {
                healthReport += `üîê <strong>Auth Service:</strong> ‚ùå Not available<br>`;
            }

            if (window.db) {
                healthReport += `üóÑÔ∏è <strong>Firestore:</strong> ‚úÖ Available<br>`;
            } else {
                healthReport += `üóÑÔ∏è <strong>Firestore:</strong> ‚ùå Not available<br>`;
            }

            // Check performance metrics
            const memInfo = performance.memory;
            if (memInfo) {
                const usedMB = Math.round(memInfo.usedJSHeapSize / 1024 / 1024);
                const totalMB = Math.round(memInfo.totalJSHeapSize / 1024 / 1024);
                healthReport += `üß† <strong>Memory Usage:</strong> ${usedMB}MB / ${totalMB}MB<br>`;
            }

            showMaintenanceResult(healthReport, navigator.onLine ? 'success' : 'warning');
        }

        async function backupSettings() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    system: 'Lunch Manager Admin System',
                    version: '1.0.0',
                    localStorage: {},
                    sessionStorage: {},
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                // Backup localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    backupData.localStorage[key] = localStorage.getItem(key);
                }

                // Backup sessionStorage (non-sensitive data only)
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    if (!key.includes('token') && !key.includes('password') && !key.includes('secret')) {
                        backupData.sessionStorage[key] = value;
                    }
                }

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `system-settings-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showMaintenanceResult('üíæ Settings backup created and downloaded successfully!', 'success');

            } catch (error) {
                console.error('Error creating backup:', error);
                showMaintenanceResult(`‚ùå Error creating backup: ${error.message}`, 'error');
            }
        }

        function generateSystemReport() {
            try {
                const report = {
                    generationTime: new Date().toISOString(),
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        onLine: navigator.onLine,
                        cookieEnabled: navigator.cookieEnabled,
                        screenResolution: `${screen.width}x${screen.height}`,
                        windowSize: `${window.innerWidth}x${window.innerHeight}`,
                        colorDepth: screen.colorDepth
                    },
                    storage: {
                        localStorage: localStorage.length,
                        sessionStorage: sessionStorage.length
                    },
                    performance: {
                        timing: performance.timing,
                        memory: performance.memory ? {
                            used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                            total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)
                        } : 'Not available'
                    },
                    services: {
                        firebase: !!window.firebase,
                        auth: !!window.auth,
                        firestore: !!window.db,
                        functions: !!window.functions
                    },
                    localStorageData: Object.keys(localStorage).reduce((obj, key) => {
                        obj[key] = localStorage.getItem(key);
                        return obj;
                    }, {})
                };

                const reportStr = JSON.stringify(report, null, 2);
                const reportBlob = new Blob([reportStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(reportBlob);
                link.download = `system-report-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showMaintenanceResult('üìã System report generated and downloaded successfully!', 'success');

            } catch (error) {
                console.error('Error generating system report:', error);
                showMaintenanceResult(`‚ùå Error generating report: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
